
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Simulations in astronomy | AP CSP (article) | Khan Academy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
  <style>
.paragraph {
  margin: 10px 0px;
}
img {
  max-width: 600px;
}
.perseus-sr-only {
  display: none;
}
li.perseus-radio-option {
  list-style-type: none;
}
  </style>
</head>
<body>
<div class="container container-md">
<h1>Simulations in astronomy | AP CSP (article) | Khan Academy</h1>
<div class="framework-perseus perseus-article bibliotron-article"><div class="clearfix"><div class="perseus-renderer perseus-renderer-responsive"><div class="paragraph" data-perseus-paragraph-index="0"><div class="paragraph">Astronomers study the universe and its vast array of celestial objects, such as planets, moons, stars, nebulae, galaxies, and comets.</div></div><div class="paragraph" data-perseus-paragraph-index="1"><div class="paragraph">The closest celestial object - the moon - is still 238,900 miles away from astronomers here on Earth. The farthest object - a galaxy - is more than 12 billion light years away. </div></div><div class="paragraph" data-perseus-paragraph-index="2"><div class="paragraph">When astronomers want to understand the workings of space, they often use simulations that they can run from the comfort of their own planet.</div></div></div></div><div class="clearfix"><div class="perseus-renderer perseus-renderer-responsive"><div class="paragraph" data-perseus-paragraph-index="0"><h2>Educational simulations</h2></div><div class="paragraph" data-perseus-paragraph-index="1"><div class="paragraph">Let's explore simulations from the <a class="_8gcxk83" href="/partner-content/nasa/searchingforlife/exploring-mars-ancient/pi/distance-between-earth-and-mars" rel="noopener noreferrer" tabindex="0" target="_blank">Khan Academy NASA content</a>. Since the primary goal of these simulations is learning, they are simpler than the ones used by actual astronomers but still similar in topic.</div></div><div class="paragraph" data-perseus-paragraph-index="2"><div class="paragraph">This first simulation predicts a lunar eclipse based on the moon's position, incline, and rotation: </div></div><div class="paragraph" data-perseus-paragraph-index="3"><div class="paragraph"><div class="perseus-widget-container widget-nohighlight widget-block"><pre>/*********************************************************
 * The orbit of the moon around the Earth.
 * 
 * Use the sliders to change the moon's orbit properties.
 * When is there a lunar eclipse?
 * 
 * Moon position is the angle of the moon around the Earth.
 * This would change over a month as the moon orbits the Earth
 * 
 * Moon incline is the inclination of the moon's orbit 
 * relative to the Earth's orbit around the sun.
 * This is ~5 degrees.
 * 
**********************************************************/
var running = true;
var speed = 0.3;

var earthX = 170;
var earthY = 250;
var earthR = 20;

var sunDistance = 10000 * earthR;
var sunR = 600 * earthR;
var focus = earthR * sunDistance / (sunR - earthR);
var sunA = 90 - atan((sunDistance + focus) / sunR);
var sunA2 = 90 - atan(sunDistance / (sunR + earthR));
var sunPoint = earthR / tan(sunA2);
var umbraPoint = earthR / tan(sunA);

var moonDist = 120;
var moonAngle = 5;
var moonR = 6;
var moonInclination = 5;

var viewAngleX = 0;
var viewAngleZ = 0;

var skyLight = color(35, 25, 100);
var skyDark = color(0, 0, 0, 128);
var moonColour = color(230, 230, 230, 255);
var moonColourT = color(230, 230, 230, 0);
var earthColour = color(40, 150, 255, 255);
var earthColourT = color(40, 150, 255, 0);
var sunColour = color(10, 10, 100, 160);
var moonImage, earthImage, moonPos, orbitPos, surfaceImage;


var surf = [];

var init = function() {
    surf = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,8,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,8,9,11,17,21,21,33,44,43,29,25,28,21,6,16,7,0,0,0,0,0,0,0,0,0,4,8,10,5,0,6,3,2,4,4,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,6,5,2,1,1,11,3,0,2,0,0,1,16,41,59,82,101,119,139,156,166,170,182,182,167,160,162,155,140,124,93,60,42,27,9,1,4,12,0,0,1,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,3,0,0,3,4,1,0,0,0,0,14,46,81,116,138,173,181,189,193,193,194,196,197,187,182,182,185,181,172,172,179,177,185,187,175,155,131,91,52,20,4,0,3,0,0,1,7,0,2,1,0,0,1,6,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,7,43,87,121,147,163,159,147,128,132,142,155,168,176,181,183,184,179,181,186,183,173,170,175,177,184,193,189,182,187,184,167,131,85,40,18,8,5,3,0,3,9,11,5,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,0,3,23,45,106,134,150,137,122,119,116,107,131,129,133,144,155,162,167,170,188,200,202,192,188,191,180,161,157,151,169,188,181,175,182,186,190,184,167,124,64,20,3,0,0,0,0,2,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,18,7,0,5,20,48,89,124,122,126,122,108,98,99,106,109,108,107,110,120,128,136,146,156,151,158,156,148,152,162,157,140,95,97,134,171,177,180,190,192,183,180,184,190,186,156,92,29,21,1,0,0,3,1,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,19,63,104,124,129,130,145,125,111,113,117,112,104,100,107,105,104,104,102,102,113,126,136,121,114,124,139,148,157,165,191,190,198,190,173,181,186,167,185,184,180,172,175,190,190,172,98,51,10,3,6,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,9,3,0,0,6,5,1,11,48,88,117,137,138,121,106,106,116,121,113,98,92,101,113,106,108,108,113,120,115,106,106,113,112,109,112,119,125,138,156,162,164,173,184,185,176,169,170,164,161,169,183,191,195,193,186,202,163,96,28,0,0,4,0,0,0,9,2,0,2,15,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,17,0,0,18,12,0,7,34,102,114,114,106,105,104,99,96,107,105,102,99,98,99,100,102,104,106,106,111,118,113,105,105,99,103,103,104,106,105,113,129,132,148,162,170,181,191,187,174,175,172,180,191,194,194,191,183,166,183,193,156,74,10,0,8,9,0,0,0,9,0,0,10,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,13,0,0,10,28,58,111,113,119,114,103,104,107,109,111,105,100,95,95,98,101,100,98,104,105,104,109,115,111,103,104,101,108,110,110,108,102,104,114,113,137,148,146,163,193,198,179,176,178,188,197,198,201,202,196,189,184,194,202,175,114,45,0,0,6,1,0,2,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,8,3,19,89,137,121,107,111,108,105,110,111,104,101,102,104,106,104,100,99,100,103,105,105,103,107,114,110,104,105,98,103,103,103,105,101,97,101,108,124,128,119,132,164,181,175,167,173,185,194,199,210,221,222,209,191,177,180,193,186,133,68,11,0,6,4,0,8,16,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,5,3,1,54,128,124,94,109,119,114,102,96,103,106,101,98,109,110,112,111,107,103,101,100,107,106,104,107,113,110,105,107,107,107,103,103,113,115,111,110,103,108,112,114,121,138,159,173,166,171,181,187,192,210,227,231,220,205,186,175,180,195,190,168,112,24,0,11,4,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,1,0,0,0,0,0,2,3,0,3,62,127,129,107,106,110,111,109,103,103,112,116,115,117,123,114,106,107,113,112,103,92,108,107,103,105,112,110,105,108,116,116,109,109,121,128,126,125,106,106,118,136,143,145,158,178,171,174,179,179,182,199,216,218,229,199,183,188,189,185,187,190,191,117,30,0,3,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,1,0,0,0,0,2,5,7,4,80,121,114,110,107,112,134,109,117,120,121,122,120,122,131,132,121,109,106,111,113,109,102,107,105,101,103,110,108,104,107,100,106,103,99,105,112,113,116,116,112,122,141,151,149,153,163,166,169,173,172,175,191,204,202,203,192,195,200,184,167,174,190,192,190,126,37,3,7,3,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,3,6,9,86,112,125,115,113,123,119,102,106,117,121,118,117,122,142,167,133,129,121,111,105,107,115,122,106,104,99,101,107,106,102,106,98,109,110,103,103,106,110,116,119,112,110,119,130,133,131,130,153,158,165,168,174,191,202,197,195,194,193,187,182,188,192,185,172,188,192,125,27,0,6,1,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,10,0,0,11,0,14,102,134,128,121,119,121,120,115,110,119,122,125,133,149,162,162,155,129,123,112,108,113,114,114,122,99,103,109,111,108,104,100,99,102,102,105,105,105,113,117,110,110,122,117,133,134,135,167,164,159,162,166,175,182,183,195,217,193,196,181,185,191,189,187,168,189,179,196,195,120,30,0,0,0,1,8,3,0,1,4,0,0,0,0,0],
[0,0,0,0,0,0,0,0,14,0,0,1,0,22,89,140,120,122,123,120,115,112,113,116,121,127,131,135,141,147,146,141,118,117,114,116,119,112,104,105,112,112,113,114,114,110,104,99,105,99,98,99,100,108,116,115,115,120,114,136,145,144,157,140,158,177,185,179,177,181,186,191,202,205,192,193,189,181,186,179,174,187,181,185,186,117,28,0,6,1,0,0,4,1,0,3,0,0,0,0],
[0,0,0,0,0,0,0,0,4,0,1,2,8,77,143,144,129,128,124,120,118,119,122,126,123,130,136,138,137,136,133,129,132,129,121,118,121,118,115,120,121,127,133,133,128,123,121,123,112,100,99,104,104,105,112,116,114,113,107,124,138,149,166,158,164,192,202,185,178,188,189,178,194,208,207,205,184,165,185,200,184,170,177,195,202,187,112,14,4,2,0,0,5,1,0,3,0,0,0,0],
[0,0,0,0,0,0,0,0,0,5,0,2,63,136,152,133,143,129,115,114,124,132,129,123,125,129,134,137,138,135,130,125,134,133,127,125,129,129,129,136,124,142,158,155,138,127,130,140,120,106,106,116,113,107,109,114,113,115,121,131,137,149,170,176,170,182,184,170,166,181,187,175,197,193,184,200,203,187,190,187,195,171,186,193,179,196,172,83,1,0,6,5,0,0,3,0,0,0,0,0],
[0,0,0,0,0,0,0,0,4,8,0,39,125,162,147,142,126,117,112,118,130,134,125,115,128,125,125,130,135,133,125,117,109,118,126,136,143,136,129,131,148,162,174,169,148,129,121,121,125,109,106,114,112,108,114,121,120,125,145,156,159,163,162,161,179,157,141,136,137,150,160,158,168,187,200,216,202,176,186,197,178,195,189,175,184,188,176,168,48,0,0,10,0,0,6,0,0,0,0,0],
[0,0,0,0,0,0,0,0,9,0,29,119,165,148,134,142,112,122,135,144,145,137,128,121,131,122,117,121,125,122,114,108,111,117,122,129,136,135,135,142,145,152,161,169,169,161,149,139,125,109,102,103,102,108,121,129,129,119,135,147,164,181,171,166,192,145,117,118,119,125,137,141,163,182,194,212,205,184,187,186,170,181,184,183,186,187,188,194,134,31,0,7,1,0,2,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,10,96,178,165,126,130,148,137,146,157,161,154,142,132,127,130,122,116,116,117,113,110,110,124,122,114,111,117,123,135,151,162,165,167,164,154,139,124,115,124,115,109,106,104,112,121,122,127,107,119,122,140,167,163,166,181,135,112,117,117,123,133,133,143,174,191,200,187,173,187,191,174,164,172,178,175,186,196,185,193,101,19,0,5,0,0,2,0,0,0,0],
[0,0,0,0,0,0,0,0,0,71,162,186,143,118,144,177,170,164,156,151,147,140,128,118,128,122,118,117,114,111,114,120,112,112,106,104,108,110,117,130,115,131,145,141,125,113,115,123,123,122,123,119,114,117,116,106,119,107,127,122,121,135,123,131,151,117,106,112,113,124,134,127,144,158,159,172,182,185,192,180,168,190,156,137,177,183,169,193,205,165,67,0,2,9,0,0,0,0,0,0],
[0,0,2,6,0,0,7,1,14,160,198,169,131,114,159,176,167,162,163,162,144,118,107,111,120,125,126,117,109,108,113,117,111,114,112,121,138,131,115,112,116,122,128,128,130,138,135,118,115,121,125,129,131,125,123,132,123,119,125,125,121,143,158,144,117,109,109,116,116,111,116,129,120,143,172,178,161,157,167,171,177,182,184,177,174,184,187,176,176,195,148,39,0,4,0,8,0,0,0,0],
[0,0,0,0,1,4,0,4,86,184,185,156,140,138,172,174,171,161,151,141,127,113,110,115,118,127,129,119,108,107,117,126,124,126,124,123,129,134,128,118,131,122,127,138,137,132,132,131,126,121,121,122,117,115,121,127,126,119,124,124,116,127,137,126,121,119,113,110,113,120,123,122,130,150,155,171,186,156,139,170,188,192,191,181,175,183,186,177,178,180,178,104,19,0,0,0,0,0,0,0],
[0,0,1,0,4,7,0,35,158,199,167,142,149,160,182,172,171,158,138,121,112,112,117,120,120,122,120,114,112,118,128,134,137,126,134,145,140,141,144,138,146,123,126,146,143,125,126,142,126,115,125,133,122,125,135,128,139,125,124,122,111,113,123,123,123,134,133,115,106,114,121,119,134,147,147,165,189,165,141,164,191,194,190,178,174,180,184,180,186,167,203,173,62,4,0,0,0,0,0,0],
[2,1,8,0,4,2,7,102,200,204,167,156,172,183,191,175,159,148,129,113,111,119,123,120,121,114,106,106,118,132,138,136,136,116,140,172,162,151,159,161,149,128,131,149,143,124,125,139,135,117,129,139,128,143,163,153,141,123,118,120,115,118,135,148,134,156,165,144,115,109,123,138,137,146,161,168,170,177,177,164,180,186,181,170,169,176,181,183,196,171,202,200,118,36,0,4,0,0,0,0],
[0,0,9,0,0,0,45,172,201,178,150,161,183,184,168,142,135,130,120,114,118,124,120,111,118,115,109,108,115,127,134,135,127,120,146,169,159,160,172,165,150,140,143,152,146,135,132,133,153,128,129,131,120,142,170,162,163,144,133,129,118,107,111,121,153,164,175,167,141,124,137,161,155,165,177,175,168,179,189,184,177,185,179,168,170,173,177,183,200,188,189,194,177,91,4,4,0,0,0,0],
[0,0,1,4,0,10,105,208,198,154,139,167,189,178,142,110,117,112,110,114,120,120,112,103,114,122,125,117,109,112,123,133,121,137,152,146,141,164,175,157,158,153,155,156,152,149,143,133,145,131,133,134,125,133,139,123,120,114,116,128,133,128,127,133,158,150,149,155,150,140,145,160,173,186,173,171,185,171,169,205,186,196,189,178,178,174,172,181,192,200,187,188,214,151,31,0,0,0,0,0],
[0,0,0,6,0,50,173,206,204,156,158,189,195,173,142,126,117,107,104,111,116,112,106,104,115,123,127,121,114,114,121,127,126,142,149,146,149,160,163,159,169,158,154,158,156,153,148,139,131,130,132,133,131,127,113,95,105,106,110,125,141,146,145,148,159,146,135,135,142,149,153,155,163,168,150,151,178,174,170,200,195,207,200,188,188,178,170,180,180,194,196,189,213,195,90,9,0,0,0,0],
[0,3,0,7,7,88,220,192,182,142,159,186,170,142,129,138,126,110,103,110,113,107,106,111,120,118,116,117,124,130,127,120,135,133,140,166,177,154,147,172,177,155,148,156,157,150,145,143,138,135,122,113,120,123,117,112,112,112,111,121,144,159,163,167,169,165,151,136,139,157,167,165,138,132,129,132,151,184,195,179,195,210,204,194,193,181,170,181,172,182,204,192,196,217,143,29,0,0,0,0],
[0,1,6,5,20,172,210,190,172,152,179,167,164,164,116,119,112,111,106,106,113,114,110,111,119,119,120,120,118,117,119,124,125,119,136,153,168,172,174,203,193,156,150,155,143,156,173,160,145,127,118,119,116,112,114,115,115,111,122,145,166,176,168,151,131,160,137,134,138,121,137,153,139,156,132,155,172,169,197,187,194,201,204,197,188,186,188,190,169,164,200,221,193,210,193,71,11,11,0,0],
[1,4,0,3,79,198,201,178,179,165,183,178,172,161,123,121,113,115,111,107,109,108,108,113,116,115,116,118,121,124,126,128,127,121,138,154,171,179,183,213,196,157,150,158,151,155,154,128,149,133,129,137,140,138,135,130,124,115,119,131,138,142,142,137,140,162,143,148,160,141,137,135,147,176,152,157,176,186,203,168,200,204,205,201,197,194,190,186,181,171,194,217,204,220,211,116,15,8,0,0],
[0,6,0,13,148,215,189,170,170,166,171,176,166,141,117,110,113,118,115,109,107,105,107,115,119,117,115,119,126,131,132,130,132,127,142,153,168,177,180,208,190,151,134,135,134,149,163,156,134,120,120,133,138,135,125,114,127,118,121,128,124,118,122,127,164,175,152,148,156,143,139,140,165,181,148,146,169,189,204,172,201,203,204,204,205,204,197,189,196,183,189,213,213,220,219,167,40,14,1,2],
[0,1,9,42,189,209,183,171,157,163,160,169,156,124,114,104,113,118,116,113,113,110,108,114,112,109,105,107,114,120,118,113,137,134,147,151,160,164,161,181,150,138,139,143,139,144,159,165,157,149,152,161,160,154,144,133,121,115,126,140,135,123,124,129,139,153,146,140,146,147,160,181,167,168,150,170,197,198,196,176,196,199,201,202,205,207,204,199,203,196,191,212,216,208,210,197,85,28,9,8],
[0,0,19,81,203,200,185,165,154,167,165,168,152,127,124,116,112,116,115,116,122,120,113,112,129,129,127,126,130,136,136,131,138,139,152,152,155,155,145,157,148,142,138,136,131,129,136,147,148,146,152,157,152,149,147,143,123,117,127,142,141,133,132,134,132,145,151,144,141,139,142,160,198,192,173,178,197,205,208,202,196,200,201,199,198,201,204,204,200,205,199,215,219,199,203,211,129,37,9,10],
[10,0,23,123,209,201,186,152,151,165,172,157,140,133,129,127,116,118,116,120,128,126,117,115,113,120,121,117,118,124,127,126,135,140,156,154,157,158,144,152,155,139,116,111,120,124,127,138,144,147,155,159,155,158,166,168,140,131,130,132,130,130,133,132,131,129,135,127,130,141,142,159,185,210,212,197,201,212,203,184,205,208,206,200,195,196,199,200,196,208,204,216,220,203,210,221,161,40,7,11],
[7,0,36,167,213,204,180,146,147,160,178,142,122,137,126,131,122,125,123,122,126,124,120,122,118,130,135,127,119,123,130,133,133,140,156,153,157,162,149,156,129,127,116,121,138,132,119,123,142,142,147,149,146,152,159,159,160,154,146,133,123,126,131,127,142,134,141,123,117,129,130,153,181,211,223,197,189,202,204,203,214,213,209,204,202,202,199,195,198,209,201,208,216,213,222,222,189,49,14,17],
[0,5,53,198,215,201,172,150,152,162,189,137,116,144,128,138,127,131,128,123,122,120,121,128,124,140,146,133,118,119,127,132,134,141,155,150,154,161,151,158,142,143,128,120,126,117,114,133,143,139,138,136,132,136,138,132,171,172,166,145,127,129,132,125,108,119,153,141,126,131,132,160,173,198,226,221,209,204,207,231,217,214,209,208,211,212,204,194,203,209,195,198,208,217,228,218,209,61,26,26],
[0,2,80,221,220,195,151,161,137,174,191,146,168,125,141,131,136,136,136,132,127,125,125,127,130,130,132,133,130,127,128,133,128,143,143,156,148,141,159,139,144,139,134,132,133,134,131,128,140,155,154,136,121,114,112,114,130,140,130,131,132,127,126,107,115,115,128,134,124,129,148,156,182,198,204,226,228,207,208,211,217,219,222,228,208,202,221,212,206,205,210,218,218,213,218,228,216,130,3,12],
[0,12,104,230,215,190,154,156,156,185,168,164,151,148,142,139,135,134,132,129,127,126,125,125,122,136,138,123,112,119,131,137,137,146,132,135,134,132,150,141,142,130,121,124,131,132,129,126,123,145,155,147,137,128,120,118,133,132,117,122,127,124,127,114,137,131,134,133,124,131,150,159,180,197,198,210,213,207,224,236,228,227,224,225,207,203,226,219,230,223,219,217,210,202,204,212,215,150,25,11],
[0,19,135,240,209,189,162,152,169,184,134,173,124,159,132,138,133,132,130,128,127,126,126,126,124,144,146,123,110,121,131,129,132,146,132,134,144,137,136,133,130,110,99,108,121,124,122,124,137,162,178,175,163,144,125,117,122,124,116,127,127,120,132,135,138,132,131,130,124,132,151,163,162,194,207,222,226,220,229,229,233,233,229,233,220,216,235,227,216,212,212,216,215,212,214,221,214,174,48,9],
[0,23,160,243,207,193,172,148,175,177,126,174,117,154,130,135,131,133,134,130,125,124,128,133,141,153,153,139,127,126,123,114,126,139,124,121,137,129,115,120,120,101,93,106,119,123,130,140,148,172,188,187,177,157,138,129,132,138,138,146,131,110,127,143,128,129,134,134,132,140,161,179,187,213,214,217,223,226,237,233,220,225,226,236,231,224,233,222,214,213,216,222,222,217,212,212,215,185,57,7],
[0,31,182,242,210,196,173,140,179,177,151,175,139,145,141,139,131,138,143,137,127,124,133,143,156,160,163,156,136,116,113,120,160,159,135,115,125,124,116,135,120,111,109,118,126,132,148,167,138,157,172,176,174,165,157,157,164,159,147,151,136,114,130,145,141,146,148,142,138,147,173,201,208,229,225,228,237,239,240,224,215,221,218,229,229,222,227,215,220,218,218,222,223,220,215,212,217,186,56,7],
[7,44,202,240,216,195,166,136,170,177,173,172,157,135,143,140,138,146,151,144,133,130,139,151,156,162,170,162,132,107,118,144,176,166,152,127,122,120,113,135,122,123,125,124,123,130,151,171,154,166,173,174,174,169,168,175,173,154,129,138,148,147,166,174,165,167,158,144,138,146,174,207,212,233,234,246,255,251,238,212,234,236,223,229,234,230,236,228,230,225,219,219,222,223,220,217,215,189,59,10],
[8,54,218,239,223,193,162,143,162,188,183,175,164,139,139,142,151,153,154,149,142,141,147,154,146,157,166,161,142,131,141,159,156,142,147,124,105,105,102,125,135,142,141,129,120,128,146,159,176,182,183,181,179,174,174,182,169,156,135,147,164,173,194,198,180,181,169,158,159,166,185,213,235,243,229,234,243,241,242,231,236,238,223,230,241,240,246,239,243,239,232,229,227,221,210,199,210,200,74,13],
[3,57,225,239,228,194,162,156,166,207,191,189,171,157,143,154,160,158,154,150,149,150,152,154,138,150,159,159,162,168,166,157,169,145,151,124,98,111,127,158,158,167,162,141,129,137,151,157,164,172,175,177,180,178,181,191,180,183,172,175,173,168,184,187,187,191,185,185,197,202,210,228,229,241,235,244,250,237,233,223,212,219,209,223,240,239,241,232,217,221,228,237,244,239,223,207,205,212,89,16],
[5,65,224,241,210,198,180,156,159,171,196,199,178,173,172,153,161,152,148,153,154,151,155,164,148,149,154,171,181,166,158,175,164,152,144,135,124,126,141,152,160,176,168,150,142,130,128,147,166,173,185,192,186,171,164,165,191,177,180,186,183,185,191,187,197,193,201,216,215,206,217,239,229,245,248,244,246,242,237,243,231,227,230,237,236,230,229,236,216,226,233,235,235,234,227,219,215,211,102,7],
[4,70,222,231,205,196,178,161,158,168,191,197,183,181,178,159,165,158,155,160,167,170,170,171,154,135,133,162,189,185,168,160,153,136,127,129,132,141,150,153,156,161,156,145,134,122,119,129,165,172,182,189,184,172,166,167,180,171,175,183,183,188,194,189,185,203,206,195,199,220,225,214,235,249,250,246,248,245,240,246,231,227,229,236,234,226,224,228,223,229,233,235,237,237,230,221,216,210,102,8],
[1,78,220,218,201,195,176,167,160,165,182,191,187,190,187,168,160,153,145,143,152,162,163,158,163,132,132,165,188,190,172,146,150,129,115,115,121,136,157,170,171,163,164,164,151,141,142,142,166,171,179,185,183,175,170,170,182,178,182,189,191,196,199,194,178,199,200,186,198,229,230,205,237,246,247,243,245,244,242,246,236,233,236,242,242,234,230,232,226,227,228,230,233,234,228,220,217,210,102,10],
[0,81,218,211,201,197,174,170,166,164,172,181,185,193,191,177,172,167,153,140,142,155,160,156,171,148,160,181,176,172,165,141,127,123,128,132,124,124,142,158,165,151,160,166,151,147,157,156,168,172,178,182,182,178,175,174,171,172,174,175,178,182,179,171,182,184,190,202,218,229,229,224,231,236,236,235,237,240,240,241,234,233,236,242,243,237,232,231,224,221,218,220,225,227,221,214,220,209,99,9],
[0,76,213,211,203,199,175,170,171,166,165,171,180,189,191,184,174,176,168,153,146,151,154,151,176,164,178,185,164,156,156,141,138,128,124,121,109,110,135,159,161,154,166,170,153,155,171,173,173,175,179,182,184,183,179,175,182,189,189,185,189,194,188,179,187,183,194,218,231,229,230,237,226,227,228,229,231,237,240,237,227,226,228,232,232,226,219,215,222,216,211,214,219,221,217,213,225,207,94,7],
[0,63,204,212,203,198,177,169,170,167,164,167,177,185,188,189,172,179,181,173,161,152,146,141,168,159,163,164,152,150,150,139,132,119,119,127,122,118,126,137,172,179,188,184,174,180,192,193,179,182,183,185,188,189,183,176,171,184,182,176,185,193,187,179,187,196,205,212,221,230,233,231,228,225,227,229,230,238,241,233,233,231,230,230,229,224,215,209,221,215,212,215,219,220,218,218,232,205,86,2],
[0,48,191,210,198,194,179,167,163,166,167,171,179,183,187,193,195,194,193,189,176,158,146,141,145,142,136,131,135,140,140,139,143,123,113,113,107,107,127,147,156,178,184,175,180,191,191,188,186,188,188,189,192,193,186,175,177,194,191,183,195,206,200,193,186,197,199,195,205,226,233,225,233,226,228,230,229,235,237,225,237,235,233,232,232,230,223,216,219,214,213,217,220,219,219,222,238,204,79,0],
[1,38,182,208,192,190,181,167,157,165,171,177,184,184,186,196,206,192,180,173,160,140,127,125,122,129,120,110,118,125,129,140,137,126,124,120,101,95,120,150,139,172,175,166,185,200,191,183,190,192,192,192,195,196,187,175,173,191,186,176,188,200,194,187,187,185,182,183,197,217,228,229,234,225,227,229,226,231,230,216,227,226,225,226,229,231,227,221,215,211,212,216,218,216,218,223,242,203,75,0],
[0,27,177,202,211,181,190,159,158,182,192,170,177,198,189,189,189,168,144,130,124,123,130,138,135,124,113,111,116,121,126,131,122,160,160,131,116,106,118,152,143,170,185,183,185,192,196,198,207,196,187,196,210,206,196,195,199,187,181,188,196,197,195,196,179,180,186,193,199,205,220,234,226,228,224,230,224,225,235,214,239,224,220,225,224,219,214,207,211,222,212,203,214,216,214,226,233,192,36,4],
[0,20,154,206,204,189,188,158,159,177,189,173,181,198,188,189,187,162,138,129,127,124,126,132,128,123,117,115,115,118,128,137,123,173,181,146,131,139,142,140,160,182,197,198,200,198,194,194,191,188,190,207,222,214,198,193,185,179,180,189,193,186,178,175,188,188,195,207,211,208,212,222,223,223,217,224,219,221,237,226,234,220,217,224,223,219,213,206,212,223,216,210,221,222,218,227,227,175,29,4],
[0,13,121,214,195,199,184,155,160,170,183,177,186,198,185,187,187,156,131,128,131,126,122,124,120,121,121,119,114,116,128,141,143,148,149,140,129,128,138,146,174,189,203,211,214,204,193,192,183,185,191,208,221,212,195,189,189,187,190,198,197,186,177,175,194,192,203,221,224,211,205,209,217,218,215,224,219,214,228,225,225,213,212,220,220,216,211,205,210,220,217,214,223,224,219,224,220,149,18,2],
[0,8,92,221,191,208,178,153,161,163,178,180,188,195,181,183,193,158,131,130,134,127,121,122,120,120,121,120,116,116,125,136,128,115,121,134,140,156,178,186,180,187,197,209,215,205,193,193,190,190,190,197,205,199,188,187,199,196,197,200,198,190,188,191,195,192,203,223,226,211,200,202,211,218,219,230,222,206,212,211,214,204,205,214,215,212,208,203,206,213,210,208,216,219,216,218,216,121,10,0],
[0,7,68,216,194,215,176,154,159,157,176,180,184,189,175,175,195,166,139,132,133,128,124,124,125,122,120,120,120,119,121,124,133,139,146,146,152,178,184,162,185,187,189,198,206,200,192,194,195,195,192,192,196,193,188,191,192,190,192,196,194,189,190,196,199,195,201,213,215,203,194,195,208,220,217,224,218,201,207,207,206,196,199,208,209,207,205,202,207,209,205,203,209,214,214,214,210,96,6,0],
[0,5,44,192,202,220,181,157,156,155,176,177,175,180,169,165,184,169,150,136,129,127,127,127,132,125,121,123,126,124,119,117,168,143,141,164,174,164,169,187,188,188,183,184,191,193,191,193,191,196,197,197,200,198,196,200,189,188,193,200,200,193,191,195,203,203,202,200,197,193,190,189,207,221,209,207,206,202,215,219,203,194,196,205,206,204,205,204,210,208,205,203,206,213,215,211,193,69,5,0],
[0,1,20,156,210,227,190,162,153,155,177,172,164,173,164,155,161,166,159,139,125,126,129,127,134,129,126,129,132,128,122,119,204,171,152,171,178,149,151,195,176,181,174,168,177,188,191,193,189,197,198,196,199,199,201,208,202,197,197,201,200,195,193,197,202,207,203,190,185,191,194,191,202,221,206,196,201,207,221,223,205,195,197,204,205,204,207,208,209,206,205,206,207,212,212,205,170,44,5,0],
[2,0,2,129,215,231,198,166,151,156,179,169,157,168,160,149,141,161,164,141,123,124,129,126,134,131,131,135,135,130,125,124,130,173,163,129,144,169,164,152,160,169,164,156,167,185,193,194,194,200,196,189,189,194,202,212,214,202,191,189,187,186,190,197,196,207,203,185,181,194,202,199,196,222,208,197,204,211,221,216,207,197,198,205,205,206,210,212,205,202,204,206,206,210,208,197,152,28,5,0],
[0,7,2,66,224,235,221,180,154,159,165,165,164,170,169,156,144,153,152,140,132,135,138,136,130,131,128,123,126,132,132,126,143,152,141,124,122,123,127,139,143,148,160,173,173,170,180,196,196,188,199,211,204,202,210,213,197,203,199,186,183,193,200,198,191,199,198,191,187,186,193,207,229,194,198,208,212,214,201,198,192,197,196,197,204,205,205,208,203,192,196,204,208,208,198,187,95,28,0,4],
[0,5,0,34,174,238,221,207,171,174,178,175,171,176,176,165,155,151,143,137,137,140,137,132,128,130,129,125,128,133,132,126,144,149,134,117,115,112,108,113,123,124,134,150,158,162,174,190,195,202,221,223,202,196,209,216,194,190,188,190,192,192,192,193,187,187,182,184,194,201,203,208,221,194,199,204,207,215,209,210,202,202,197,196,205,207,203,202,202,199,195,200,199,203,198,163,55,9,0,1],
[1,5,0,8,107,229,222,225,191,190,190,183,176,179,179,170,160,148,135,130,129,126,123,122,123,127,127,124,125,128,124,117,123,126,114,107,114,116,111,115,124,119,123,137,148,157,173,190,202,212,230,227,205,203,213,214,205,194,194,207,211,202,196,200,191,185,178,187,209,219,214,210,208,192,197,194,198,214,214,217,206,204,195,193,202,206,200,195,200,205,194,198,193,200,196,121,16,0,0,1],
[0,6,0,9,51,196,227,221,201,198,195,186,176,176,176,170,166,155,146,143,135,122,116,120,124,129,131,127,126,127,122,115,128,130,117,108,113,110,105,110,137,129,126,131,136,145,167,190,215,212,214,212,207,217,220,205,204,197,196,201,200,192,188,191,191,190,187,195,212,215,206,200,200,191,195,185,192,213,209,208,200,202,195,190,198,203,199,196,196,206,194,202,198,202,181,72,3,0,3,4],
[0,6,0,16,14,140,229,218,205,201,198,189,177,173,174,169,170,161,160,171,172,155,134,122,123,130,133,130,129,132,129,123,124,127,117,110,113,110,110,121,130,124,120,119,118,128,157,188,219,205,196,192,195,213,217,199,212,218,215,201,192,192,194,192,181,192,199,202,203,196,189,190,202,196,195,185,196,214,201,194,193,202,201,194,197,203,203,204,192,199,196,208,207,199,148,30,3,4,5,2],
[0,2,0,9,0,75,199,221,205,202,201,195,182,176,176,173,158,149,153,177,198,190,155,124,116,122,125,121,121,125,127,123,111,116,111,110,117,116,118,133,117,115,116,118,116,125,157,190,205,191,183,178,175,191,206,203,224,236,234,215,202,205,207,203,185,204,216,214,204,192,191,202,205,199,198,189,202,213,194,189,193,208,209,201,201,206,207,208,193,189,199,208,206,179,97,7,1,2,0,0],
[1,0,3,0,0,23,132,217,200,198,202,199,187,179,178,175,148,143,144,161,184,191,172,148,128,132,130,121,117,121,123,122,126,127,119,118,123,114,105,112,115,114,119,125,125,129,151,176,183,167,164,165,163,179,202,211,212,219,223,218,209,203,199,196,200,216,223,216,205,196,199,212,200,196,195,188,200,205,188,193,199,212,212,202,202,206,202,197,197,180,202,200,192,145,42,1,0,0,0,0],
[1,0,19,0,8,0,70,205,194,194,200,200,188,179,178,175,154,156,152,149,159,178,187,186,159,161,153,139,130,130,131,129,121,121,116,122,134,126,112,114,116,115,120,127,126,123,133,149,167,145,142,154,164,182,206,215,210,208,217,231,229,211,200,201,207,215,214,204,195,189,193,205,191,188,190,184,193,195,182,198,203,213,209,198,200,203,193,182,201,176,204,192,176,118,6,3,0,2,1,2],
[3,5,0,0,6,0,33,141,213,203,195,205,195,187,201,194,191,197,169,162,193,193,182,202,192,172,156,177,171,161,164,121,115,115,119,126,128,123,116,113,106,116,112,115,127,122,123,145,145,142,152,159,161,178,196,196,188,212,219,219,224,211,195,201,225,210,202,199,195,195,197,195,189,187,190,196,199,198,201,206,203,208,218,197,201,210,184,189,191,180,182,190,145,45,0,3,0,0,0,0],
[0,4,0,2,4,0,12,72,190,211,190,190,208,191,180,186,188,192,175,172,196,199,192,206,209,203,173,172,174,166,168,146,120,120,121,120,115,110,113,118,123,118,122,127,124,121,124,128,142,146,150,149,148,155,167,174,194,199,194,189,193,195,197,204,204,195,195,200,200,200,197,190,192,188,187,193,198,199,201,205,193,204,219,202,202,207,186,194,183,178,187,171,98,21,0,2,0,0,0,0],
[0,2,4,1,0,0,0,9,118,205,197,176,207,203,190,205,191,191,187,188,198,202,202,205,205,220,191,174,179,169,160,153,135,126,117,112,109,109,113,119,122,112,125,131,114,118,135,133,141,155,156,154,162,164,171,190,175,162,156,158,165,184,203,207,184,182,191,203,203,199,193,184,195,189,186,190,196,199,202,204,193,207,219,203,198,195,179,189,179,181,183,131,37,0,3,0,0,0,0,0],
[4,0,1,0,0,1,4,0,35,169,212,182,180,191,203,207,197,194,199,202,198,202,206,199,196,214,195,169,164,158,150,145,145,127,111,109,115,119,116,113,110,113,128,133,127,140,164,173,176,190,180,173,182,172,164,181,174,153,149,153,149,161,173,165,181,183,195,203,198,192,189,185,194,192,190,190,191,195,201,206,208,215,211,196,189,179,169,177,185,184,155,75,0,0,6,0,0,0,0,0],
[8,0,0,4,0,0,7,3,1,106,195,210,173,167,193,181,196,194,204,207,199,204,209,197,204,204,196,166,146,149,145,135,135,123,114,113,116,116,114,112,112,126,130,139,165,182,187,195,184,192,180,176,188,172,152,160,159,141,144,151,144,149,159,151,186,188,197,199,190,186,192,197,192,195,195,191,188,192,201,209,218,216,195,185,186,176,172,176,188,172,105,23,0,0,5,0,0,0,0,0],
[4,0,0,8,2,0,0,3,2,35,131,221,208,179,195,186,192,195,202,204,202,209,212,202,199,196,206,188,169,164,139,121,121,121,121,117,110,105,109,116,119,129,121,132,179,198,182,172,172,175,172,181,193,178,155,152,136,130,135,141,140,148,168,181,189,186,190,191,185,188,200,208,193,197,198,192,188,193,202,208,212,207,178,181,191,180,178,177,170,130,51,0,0,8,2,0,0,0,0,0],
[0,0,0,1,1,0,0,0,3,0,53,168,219,199,198,206,194,201,202,199,206,212,210,205,189,189,200,191,195,185,140,132,131,125,118,113,109,107,112,118,124,125,118,123,152,178,177,163,184,181,189,202,199,178,154,140,148,151,146,137,131,132,155,189,191,181,179,184,187,194,202,203,197,198,195,191,192,199,203,202,199,197,170,182,192,171,165,157,133,70,11,0,2,3,0,0,0,0,0,0],
[0,8,1,0,0,3,0,1,1,1,5,93,190,190,178,199,200,210,204,197,208,213,206,203,194,190,177,160,189,191,151,171,155,131,109,105,115,122,120,115,131,128,132,125,122,157,190,188,170,169,191,213,206,188,172,156,143,155,149,136,131,129,155,202,193,177,171,180,190,198,198,190,202,198,192,189,196,205,204,197,191,195,170,185,189,155,142,128,102,24,0,6,2,0,0,1,0,0,0,0],
[0,0,0,0,0,0,0,0,0,18,0,10,120,199,195,184,189,205,204,197,200,196,206,235,196,187,165,180,188,192,205,175,177,183,158,114,117,126,108,118,124,123,117,117,135,163,174,170,176,171,174,188,198,193,182,174,152,145,158,170,158,149,158,164,145,174,191,189,190,193,190,185,185,200,193,179,194,216,208,184,188,173,183,194,173,144,121,100,26,9,0,0,2,0,0,1,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,2,7,46,136,202,204,213,217,219,212,209,214,211,197,192,195,186,193,182,179,207,204,175,172,187,154,113,128,147,149,115,129,135,130,130,145,163,172,164,163,168,180,194,200,195,189,185,212,215,195,185,178,166,158,180,199,203,192,190,196,199,200,189,201,206,206,209,202,184,173,186,161,188,194,146,134,113,37,14,3,0,0,4,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,6,0,3,6,0,50,154,208,190,191,212,219,203,204,205,185,202,190,175,187,192,196,217,216,199,172,182,160,125,147,162,144,133,133,133,139,152,157,145,127,165,159,149,146,162,188,205,209,171,192,182,170,178,170,165,188,173,192,200,195,195,197,195,194,211,210,211,214,205,181,172,183,170,178,176,162,143,107,50,2,2,0,0,3,4,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,3,0,0,6,0,0,59,160,197,185,194,207,203,201,207,208,195,180,170,180,189,195,211,219,220,198,188,163,150,158,146,134,146,152,155,149,138,130,125,123,132,141,144,146,158,176,179,170,171,200,186,153,159,177,176,171,171,189,201,206,213,216,215,216,223,217,212,210,199,177,173,190,170,183,158,134,119,55,0,4,0,0,0,3,3,0,0,1,0,0,0,0],
[0,0,0,0,0,0,0,0,0,6,0,2,13,0,0,72,181,190,184,181,193,196,193,199,177,185,194,182,162,156,175,209,206,206,222,203,173,162,149,145,172,163,148,132,119,116,123,133,118,129,136,137,144,157,156,146,187,168,172,189,180,157,150,157,185,192,194,198,209,219,229,239,218,220,214,208,202,186,172,170,182,161,147,114,50,6,0,2,1,1,2,2,0,0,0,3,0,0,0,0],
[0,0,0,0,0,0,0,0,0,5,2,0,0,5,2,0,56,143,195,192,187,182,180,191,192,191,191,165,148,143,139,160,180,162,200,215,190,190,174,139,169,146,126,125,131,130,123,117,128,128,123,116,121,137,150,154,173,172,183,184,173,179,184,171,187,191,193,200,211,215,218,226,226,223,206,190,187,183,169,159,157,152,117,56,7,0,0,3,4,4,2,0,0,0,1,3,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,2,0,0,8,8,0,0,62,150,194,199,192,197,209,206,187,169,140,145,155,128,125,150,122,148,178,194,208,184,148,135,132,133,135,127,115,114,122,116,119,122,126,129,132,136,140,168,167,166,162,148,136,144,164,186,191,199,214,225,222,217,221,229,216,192,175,174,171,162,157,117,113,55,2,3,1,0,4,1,1,0,0,0,1,2,1,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,6,16,0,34,131,190,202,202,197,188,181,172,134,134,150,131,138,119,127,135,147,185,195,175,194,155,128,107,109,118,118,117,119,127,120,116,116,117,120,132,145,151,194,194,163,152,144,139,152,178,176,177,190,205,209,213,224,209,198,185,185,184,168,149,145,106,38,3,2,0,5,13,0,0,0,0,0,1,4,2,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,4,0,20,93,176,207,193,202,192,178,161,142,128,126,130,121,119,125,127,137,175,196,179,189,157,118,106,116,119,113,111,122,123,120,115,119,130,139,142,157,163,161,149,144,155,166,171,188,178,184,200,206,204,202,199,198,189,180,171,164,150,112,67,10,7,2,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,10,4,15,69,152,214,190,201,196,167,143,135,129,118,131,127,126,119,122,158,183,172,180,169,143,119,108,103,107,117,107,116,124,129,134,141,142,139,129,139,145,146,154,171,185,190,190,184,192,203,201,193,190,188,195,178,166,162,153,121,60,1,7,5,2,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,2,58,118,200,196,190,177,153,129,121,125,114,114,118,115,121,155,180,173,185,190,173,140,117,111,117,129,129,130,131,133,139,145,146,143,145,152,158,161,169,182,189,189,185,182,191,199,193,187,188,189,164,172,175,143,77,23,2,0,3,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,0,0,4,8,0,0,6,69,145,205,204,181,168,146,118,129,128,126,122,130,159,175,168,181,188,172,142,127,125,125,125,141,137,135,145,160,168,165,156,160,161,158,156,158,164,163,159,175,171,175,181,178,177,181,182,173,137,98,60,19,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,2,0,29,93,164,205,203,181,165,134,147,163,174,184,188,171,145,170,180,171,150,142,143,141,139,129,128,139,167,195,202,186,167,164,160,154,152,156,162,163,162,174,170,175,180,174,163,150,136,141,73,11,0,1,8,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,4,0,0,0,6,6,0,5,10,33,93,163,195,192,194,193,183,174,176,181,173,160,146,164,168,156,145,142,146,154,155,147,149,170,193,198,183,167,176,170,163,160,163,168,171,173,167,161,161,164,159,153,140,125,40,17,3,0,0,0,1,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,2,0,0,4,5,0,0,0,0,9,15,13,29,85,143,176,186,186,177,174,168,154,144,127,144,154,151,144,136,140,153,183,168,156,160,168,171,169,166,171,165,159,155,155,156,160,163,163,165,170,161,131,89,44,9,0,0,0,4,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3,2,0,0,6,6,0,0,0,1,2,8,16,64,104,144,171,188,189,178,171,151,159,165,172,173,165,162,170,164,158,156,161,165,165,165,168,163,161,159,161,162,165,170,175,171,147,110,66,26,7,3,0,7,0,0,0,0,2,3,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,14,33,61,96,136,170,191,186,190,183,163,149,151,158,160,168,166,162,158,160,165,168,167,150,159,168,169,173,177,155,118,61,33,7,0,2,2,3,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,9,31,55,71,122,142,161,168,171,174,173,167,164,166,167,168,172,178,179,177,174,165,148,123,100,82,53,19,17,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,3,7,3,16,30,37,44,51,52,49,73,77,81,85,89,93,92,88,61,45,27,11,1,1,2,0,0,0,0,4,3,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,7,7,5,3,2,3,2,0,0,0,2,5,4,2,5,8,8,10,12,9,4,6,1,6,11,7,1,0,0,2,1,2,4,1,0,2,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
];
};

// Given an angle around the orbit, return Cartesian coordinates
// Takes into around the orbit inclination and view rotations
var angleToPosition = function(theta) {
    // Position on inclined circle
    var x = cos(theta) * moonDist * cos(moonInclination);
    var y = sin(theta) * moonDist;
    var z = cos(theta) * moonDist * sin(moonInclination);
    
    // Rotate around z-axis
    var x1 = cos(viewAngleZ) * x + sin(viewAngleZ) * y;
    var y1 = cos(viewAngleZ) * y - sin(viewAngleZ) * x;
    
    // Rotate around y-axis
    var y2 = cos(viewAngleX) * y1 - sin(viewAngleX) * z;
    
    return [x1, y2];
};

var drawShadedSphere = function(cx, cy, r, theta, col, colT) {
    var r2 = r*r;
    var s = 90 /r;
    
    for (var y = -r; y &lt;= r; y++) {
        var d = sqrt(r2 - y*y);
        var rd = round(d);
        var light1 = cos(s * y);
        var w = 90 / d;
        
        for (var x = -rd-1; x &lt;= rd+1; x++) {
            var p = light1 * cos(theta + (x / d) * 90);
            if (p &gt;= 0 &amp;&amp; p &lt;= 1) {
                if (x &lt; -rd || x &gt; rd) {
                    p *= d + 0.5 - rd;
                } 
                var c = lerpColor(colT, col, p);
                stroke(c);
                point(cx + r + x + 1, cy + r + y + 1);   
            }
        }
    }
};

var drawEarth = function() {
    noStroke();
    fill(0, 16, 32);
    fill(earthColour);
    ellipse(earthX + 1, earthY, earthR * 2, earthR * 2);
    //image(earthImage, earthX - earthR, earthY - earthR - 2);
    
    fill(0, 0, 0, 200);
    arc(earthX + 1, earthY, earthR * 2+1, earthR * 2+1, -90, 90);
};

// Find whether in shade or in front of Earth
// Used to determine drawing order
var findPosition = function(theta) {
    var coords = angleToPosition(theta);
    var x = coords[0] + earthX;
    var y = coords[1] + earthY;
    
    theta = (360 + theta - viewAngleZ) % 360;
    var height = sin(moonInclination);
    if (x &gt; earthX) {
        var y2 = sin(theta) * moonDist;
        var z2 = cos(theta - viewAngleZ) * moonDist * height;
        var d = sqrt(y2*y2 + z2*z2);
        
        var umbra = tan(sunA) * (umbraPoint - (x - earthX));
        if (d - moonR &lt; umbra) {
            return ["umbra", x, y];
        }
        
        var penumbra = tan(sunA2) * (sunPoint + x - earthX);
        if (d - moonR &lt; penumbra) {
            return ["penumbra", x, y];
        }
    }
    
    if (theta &gt; 180) {
        return ["back", x, y]; 
    } else {
        return ["front", x, y];
    }
};

// Update positions so shading is done correctly
var findMoonPositions = function() {
    orbitPos = { penumbra: [], umbra: [], back: [], front: [] };
    
    // Orbit path
    for (var t=0; t &lt; 360; t += 4) {
        var p = findPosition(t);
        orbitPos[p[0]].push([p[1], p[2]]);
    }
    
    moonPos = findPosition(moonAngle + viewAngleZ);
};

// Draw moon and moon orbit if in the correct position
var drawMoon = function(pos) {    
    fill(lerpColor(moonColourT, moonColour, 0.2));
    noStroke();
    for (var orb in orbitPos[pos]) {
        var x = orbitPos[pos][orb][0];
        var y = orbitPos[pos][orb][1];
        ellipse(x, y, 3, 3);
    }
    
    if (pos === moonPos[0]) {
        var x = moonPos[1];
        var y = moonPos[2];
        fill(moonColour);
        noStroke();
        ellipse(x, y, moonR * 2, moonR * 2);
        //image(moonImage, x - moonR, y - moonR - 1);     
    }
};

var drawPenumbra = function() {
    var dx = 400 * cos(sunA2);
    var dy = 400 * sin(sunA2) + earthR;
    
    noStroke();
    fill(skyDark);
    
    beginShape();
        vertex(earthX, earthY - earthR);
        vertex(earthX, earthY + earthR);
        vertex(earthX + dx , earthY + dy);
        vertex(earthX + dx, earthY - dy);
    endShape();
};

var drawUmbra = function() {    
    var dx = (earthR+1) * cos(90 - sunA);
    var dy = (earthR+1) * sin(90 - sunA);
    
    noStroke();
    fill(skyDark);
    
    beginShape();
        vertex(earthX + dx, earthY - dy);
        vertex(earthX + dx, earthY + dy);
        vertex(earthX + focus, earthY);
    endShape();
    beginShape();
        vertex(earthX + dx, earthY - dy);
        vertex(earthX + dx, earthY + dy);
        vertex(earthX + focus, earthY);
    endShape();
};

// Currently broken
var getSphereImage = function(r, theta, col, colT) {
    var img = createGraphics(r*2 + 2, r*2 + 2, JAVA2D);
    img.beginDraw();
    img.background(0, 0, 0, 0);
    
    var r2 = r*r;
    var s = 90 /r;
    
    for (var y = -r; y &lt;= r; y++) {
        var d = sqrt(r2 - y*y);
        var rd = round(d);
        var light1 = cos(s * y);
        var w = 90 / d;
        
        for (var x = -rd-1; x &lt;= rd+1; x++) {
            var p = light1 * cos(theta + (x / d) * 90);
            if (p &gt;= 0 &amp;&amp; p &lt;= 1) {
                if (x &lt; -rd || x &gt; rd) {
                    p *= d + 0.5 - rd;
                } 
                var c = lerpColor(colT, col, p);
                img.stroke(c);
                img.point(r+x+1, r+y+1);   
            }
        }
    }
    
    return img;
};


// Get (x, y) coords given actual (x, y, z)
// and taking into account rotations
var updatePosition = function(x, y, z) {
    // Rotate around z-axis
    var x1 = cos(viewAngleZ) * x + sin(viewAngleZ) * y;
    var y1 = cos(viewAngleZ) * y - sin(viewAngleZ) * x;
    
    // Rotate around y-axis
    var y2 = cos(viewAngleX) * y1 - sin(viewAngleX) * z;
    return [x1, y2];
};

var drawMoonOrbitAxis = function(side) {
    stroke(255, 255, 255, 160);
    strokeWeight(2);
    
    // Position on inclined circle
    var d = 50;
    var coord1 = updatePosition(-d * sin(moonInclination), 0,
                                 d * cos(moonInclination));
                                 
    d = earthR;
    var coord2 = updatePosition(-d * sin(moonInclination), 0,
                                 d * cos(moonInclination));
    
    var x1 = earthX + side * coord1[0];
    var y1 = earthY + side * coord1[1];
    var x2 = earthX + side * coord2[0];
    var y2 = earthY + side * coord2[1];
    line(x1, y1, x2, y2);
};

var boxX = 265;
var boxY = 10;
var boxW = 125;

var drawMoonSurface = function(sx, sy) {
    if (this.loadPixels) {
        this.loadPixels();
    } else {
        return;
    }
    
    var p = this.imageData.data;
    var n, row;
    for (var x = 0; x &lt; surf.length; x++) {
        row = surf[x];
        for (var y = 0; y &lt; row.length; y++) {
            n = sx + x + (y + sy) * 400 &lt;&lt; 2;
            p[n] = row[y];
            p[n+1] = row[y];
            p[n+2] = row[y];
        }
    }
    
    updatePixels();
    
    /*
    noStroke();
    fill(moonColour);
    ellipse(x, y, r, r);
    */
};

var drawView = function() {  
    noStroke();
    fill(0);
    rect(boxX + 1, boxY + 1, boxW - 2, boxW - 2, 3);

    // Calculate position as seen from Earth
    var theta = moonAngle;
    var y2 = sin(theta) * moonDist;
    var z2 = cos(theta - viewAngleZ) * moonDist*sin(moonInclination);
    var d = sqrt(y2 * y2 + z2 * z2);
    
    // Moon
    var cx = boxX + boxW/2;
    var cy = boxY + boxW/2;
    var r = 100;

    drawMoonSurface(round(cx - r / 2), round(cy - r / 2));

    //image(surfaceImage, cx - r/2, cy - r/2);
    
    // Check moon not in front of Earth
    if (moonPos[1] &lt; earthX) { return; }
    
    // Shadow
    var _scale = 0.5 * r / moonR;
    var umbra = tan(sunA) * (umbraPoint - (moonPos[1] - earthX));
    var penumbra = tan(sunA2) * (sunPoint + moonPos[1] - earthX);
    umbra *= _scale;
    penumbra *= _scale;

    fill(0, 0, 0, 240);
    ellipse(cx + y2 * _scale, cy + z2 * _scale, umbra*2, umbra*2);
    
    fill(0, 0, 0, 50);
    ellipse(cx + y2 * _scale, cy + z2 * _scale, penumbra*2, penumbra*2);
};

/*******************************************************
 *         Sliders
*******************************************************/

var Slider = function(x, y, w, min_v, max_v, current_v) {
    this.x = x;
    this.y = y;
    this.width = w;
    this.min = min_v;
    this.max = max_v;
    this.scale = (max_v - min_v) / w;
    this.val = current_v || min_v;
    this.bx = this.x + (this.val - min_v) / this.scale;
    
    this.held = false;

    this.draw = function() {
        noStroke();
        fill(200);
        rect(this.x, this.y-1, this.width+2, 3, 4);
        
        strokeWeight(1);
        stroke(60);
        line(this.x + 1, this.y-1, x + this.width, this.y);
    
        fill(180);
        stroke(50);
        rect(this.bx, this.y-8, 10, 16, 3);
        
        for (var i=0; i&lt;3; i++) {
            var y = this.y + i*3 - 3;
            stroke(50);
            line(this.bx + 3, y, this.bx + 7, y); 
            stroke(200);
            line(this.bx + 3, y+1, this.bx + 7, y+1); 
        }
    };
    
    this.selected = function() {
        this.held = mouseX &gt; this.bx - 1 &amp;&amp; mouseX &lt; this.bx + 11 &amp;&amp; 
                    mouseY &gt; this.y - 9 &amp;&amp; mouseY &lt; this.y + 9;
    };
    
    this.drag = function() {
        if (this.held) {
            var x = constrain(mouseX, this.x, this.x + this.width);
            this.bx = x;
            this.val = this.min + (x - this.x) * this.scale;
        }
    };
    
    this.update = function(d) {
        this.val = constrain(this.val + d, this.min, this.max);
        this.bx = (this.val - this.min) / this.scale + this.x;
    };
};



findMoonPositions();

var slideX = 120;
var slideY = 15;
var sliders = [
    new Slider(slideX, slideY, 120, -180, 180, moonAngle),
    new Slider(slideX, slideY+20, 120, 0, 90, moonInclination),
    new Slider(slideX, slideY+40, 120, 0, 90),
    new Slider(slideX, slideY+60, 120, 0, 360)
];

var clearAllButView = function() {
    noStroke();
    fill(skyLight);
    rect(0, 0, boxX, 400);
    rect(0, 0, 400, boxY);
    rect(0, boxY + boxW, 400, 400);
    rect(boxX + boxW, 0, 400, 400);
    
    // Outline view
    noFill();
    strokeWeight(3);
    stroke(200);
    rect(boxX, boxY, boxW, boxW, 3);
    
    strokeWeight(1);
    stroke(100);
    rect(boxX+1, boxY+1, boxW-2, boxW-2,3);
};

var draw = function() {
    if (!surf.length) {
        init();
    }
    if (this.loadPixels) {
        this.loadPixels();
    } else {
        return;
    }
    
    drawView();
    clearAllButView();
    
    for (var s in sliders) {
        sliders[s].draw();
    }
    
    drawMoon("umbra");
    drawUmbra();
    drawMoon("penumbra");
    drawPenumbra();
    drawMoon("back");
    drawMoonOrbitAxis(-1);
    drawEarth();
    drawMoonOrbitAxis(1);
    drawMoon("front");
    
    fill(255);
    textAlign(LEFT, CENTER);
    text("Moon position: " + round(360 + moonAngle)%360, 10, slideY);
    text("Moon incline: " + round(moonInclination), 10, slideY+20);
    text("X-axis rotation: " + round(viewAngleX), 10, slideY+40);
    text("Z-axis rotation: " + round(viewAngleZ), 10, slideY+60);
};

// Spacebar toggles animation
var keyPressed = function() {
    if (keyCode === 32) { running = !running; }
};

var mousePressed = function() {
    for (var s in sliders) {
        sliders[s].selected();
    }
};

var mouseReleased = function() {
    for (var s in sliders) {
        sliders[s].held = false;
    }
};

var mouseDragged = function() {
    var draggedSlider = false;
    
    for (var s in sliders) {
        sliders[s].drag();
        if (sliders[s].held) {
            draggedSlider = true;
        }
    }
    moonAngle = sliders[0].val;
    moonInclination = sliders[1].val;
    viewAngleX = sliders[2].val;
    viewAngleZ = sliders[3].val;
    
    if (!draggedSlider) {
        sliders[2].update(mouseY - pmouseY);
        viewAngleX = sliders[2].val;
    }
    
    findMoonPositions();
};</pre></div></div></div></div></div><div class="clearfix"><div class="perseus-renderer perseus-renderer-responsive"><div class="paragraph" data-perseus-paragraph-index="0"><div class="paragraph">The next simulation shows the predicted results from launching a satellite to Mars on different dates of the year. NASA engineers used simulations like this to come up with launch dates for their satellites.</div></div><div class="paragraph" data-perseus-paragraph-index="1"><div class="paragraph"><div class="perseus-widget-container widget-nohighlight widget-block"><pre>/****************************************
 * Make slider update more efficient
 * Show launch date and distance to Mars
 * Add keyboard control of parameters
 * Rocket power slider
 * Show rocket position
 * Show planet position at intersection
****************************************/

// How accurate orbit speed is
var resolution = 4;

// Display parameters
var sunX = 233;
var sunY = 391;
var sunR = 32;
var sliderW = 320;
var TEXTCOL = color(255, 255, 255, 200);

// Scale for drawing orbits
var SCALE = 0.88;
// 6 Aug
var GRAVITY = 0.002631;
var launchSpeed = 0.1;

var marsData = {
    size: 12,
    colour: color(212, 95, 17),
    perihelion: 207,        // million km
    aperihelion: 249,       // million km
    longitude: 336,         // degrees
    year: 686.98,           // earth days
    mass: 0.64              // 10^24 kg
};

var earthData = {
    size: 24,
    colour: color(61, 100, 255),
    perihelion: 147,        // million km
    aperihelion: 152,       // million km
    longitude: 102,         // degrees
    year: 365.25,           // earth days
    mass: 5.97              // 10^24 kg
};

// At 6pm 28th August 2003, Earth and Mars in opposition
// Angles from ellipse centres, not sun
var earthAngle = -0.681;
var marsAngle = 23.632;

var startYear = 2000;
var _year = 0;
var _month = 0;
var _day = 0;
var _hour = 18;

var totalDays = 0;

// Other variables
var running = false;
var showCycles = true;
var mode = "choice";

var minDist, oldDist;

var sliders = [];
var options = [];

var Sun = function() {
    this.x = 0;
    this.y = 0;
    this.drawX = sunX;
    this.drawY = sunY;
    this.mass = 330000;
    
    this.draw = function() {
        noStroke();
        fill(255, 204, 0);
        ellipse(sunX, sunY, sunR, sunR);
        fill(255, 151, 33, 200);
        
        var flareA = 10;
        var flare = 3 + sin(frameCount * 10);
        
        beginShape();
            curveVertex(sunX + sunR/2 + flare, sunY);
            var up = true;
            for (var i = 0; i &lt;= 360; i += flareA) {
                var r = up ? sunR/2 + flare : sunR/2;
                curveVertex(sunX + r * cos(i),
                            sunY + r * sin(i));
                up = !up;
            }
            curveVertex(sunX + sunR/2, sunY);
        endShape();
    };
};

var Planet = function(data, angle) {
    this.year = data.year;
    this.mass = data.mass;
    
    // Distance from ellipse centre to sun
    var focusDist = 0.5 * (data.aperihelion - data.perihelion);
    
    // Ellipse axes
    var major = data.aperihelion - focusDist;
    var minor = sqrt(major * major - focusDist * focusDist);
    
    // Store these to save repeatedly calculating them
    var phi = data.longitude;
    var cosPhi = cos(phi);
    var sinPhi = sin(phi);
    
    // Angle relative the perihelion
    this.angles = [angle];
    
    // Center of ellipse
    var cx = -focusDist * cosPhi;
    var cy = focusDist * sinPhi;
    
    // Handy properties for calculations
    var eccentricity = focusDist / major;
    var eccConstant = major * (1 - eccentricity * eccentricity);
    var angleConstant = 360 * major * minor / this.year / resolution;

    // Store a list of angles around the sun
    this.findAngles = function(n) {
        var angle = this.angles[this.angles.length - 1];
        
        for (var i = 0; i &lt; n - 1; i++) {
            // Distance from sun
            var r = eccConstant / (1 + eccentricity * cos(angle));
            
            // Update angle around sun
            angle += angleConstant / (r * r);
            this.angles.push(angle);
        }
    };

    // Get the position of the planet for a given day
    this.findPosition = function(day) {
        var n = (day * resolution) % this.angles.length;
        var angle = this.angles[n];
        var r = eccConstant / (1 + eccentricity * cos(angle));

        // Position based on non-rotated ellipse
        var x = r * cos(angle) + focusDist;
        var y = r * sin(angle);
        
        // Rotate based on ellipse rotation
        var x2 = cx + x * cosPhi - y * sinPhi;
        var y2 = cy - x * sinPhi - y * cosPhi;
        
        return [x2, y2];
    };
    
    this.update = function() {
        var pos = this.findPosition(totalDays);
        
        this.x = pos[0];
        this.y = pos[1];
        this.drawX = sunX + this.x * SCALE;
        this.drawY = sunY + this.y * SCALE;
    };
    
    // Cache angles for a year
    this.findAngles(round(this.year * resolution));
    this.update();
    
    this.drawCycle = function(col) {
        var m1 = major * 2 * SCALE;
        var m2 = minor * 2 * SCALE;
        
        pushMatrix();
        translate(sunX + cx * SCALE, sunY + cy * SCALE);
        rotate(data.longitude);
        
        strokeWeight(3);
        stroke(col);
        ellipse(0, 0, m1, m2);
        strokeWeight(1);
        stroke(255, 255, 255, 42);
        ellipse(0, 0, m1, m2);
        popMatrix();
    };
    
    this.draw = function() {
        fill(data.colour);
        ellipse(this.drawX, this.drawY, data.size, data.size);
    };
};

/********************************************************
 *               Make planets here
*********************************************************/
var sun = new Sun();
var mars = new Planet(marsData, marsAngle);
var earth = new Planet(earthData, earthAngle);
var bodies = [sun, earth, mars];


/********************************************************
 *               Shuttle code
*********************************************************/

var shuttles;
var Shuttle = function(x, y, dx, dy) {
    this.x = x;
    this.y = y;
    this.dx = dx;
    this.dy = dy;
    
    this.oldPositions = [[this.x, this.y]];
    this.distsToEarth = [dist(this.x, this.y, earth.x, earth.y)];
    this.distsToMars = [dist(this.x, this.y, mars.x, mars.y)];
    this.maxDist = max(this.distsToEarth[0], this.distsToMars[0]);
    this.daysInFlight = 0;
    
    this.draw = function() {
        noStroke();
        fill(160);
        
        var coord;
        for (var i = 0; i &lt; this.oldPositions.length; i++) {
            coord = this.oldPositions[i];
            ellipse(coord[0], coord[1], 2, 2);
        }
        
        if (this.oldPositions.length &gt; 1) {
            var x = sunX + this.x * SCALE;
            var y = sunY + this.y * SCALE;
    
            var angle = atan2(this.dy, this.dx);
            var r = -6;
            var dAngle = 30;
            var dx1 = r * cos(angle + dAngle);
            var dy1 = r * sin(angle + dAngle);
            var dx2 = r * cos(angle - dAngle);
            var dy2 = r * sin(angle - dAngle);
            
            fill(255);
            triangle(x, y, x + dx1, y + dy1, x + dx2, y + dy2);
        }
        
        //ellipse(x, y, 3, 3);
    };
    
    this.update = function() {
        this.daysInFlight++;
        if (this.daysInFlight % 4 === 0) {
            this.oldPositions.push([sunX + this.x * SCALE, sunY + this.y * SCALE]);
            if (this.oldPositions.length &gt; 140) {
                this.oldPositions.shift();
            }
            var dEarth = dist(this.x, this.y, earth.x, earth.y);
            var dMars = dist(this.x, this.y, mars.x, mars.y);
            this.distsToEarth.push(dEarth);
            this.distsToMars.push(dMars);
            this.maxDist = max(this.maxDist, dEarth);
            this.maxDist = max(this.maxDist, dMars);
        }
        
        // Update position
        this.x += this.dx;
        this.y += this.dy;
        
        // Update velocity
        for (var i in bodies) {
            var b = bodies[i];
            var dx = this.x - b.x;
            var dy = this.y - b.y;
            var d2 = dx * dx + dy * dy;
            var f = GRAVITY * b.mass / d2;
            var theta = atan2(dy, dx);
            this.dx -= f * cos(theta);
            this.dy -= f * sin(theta);
        }
    };
};

/****************************************
 *               Date functions
*****************************************/

var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
var monthDays = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

var isLeapYear = function(y) {
    return (y % 4 === 0 &amp;&amp; (y % 100 !== 0 || y % 400 === 0));
};

// Return the number of days in given month for a given year
var daysInMonth = function(m, y) {
    var d = monthDays[m];
    d += (m === 1 &amp;&amp; isLeapYear(y));
    return d;
};

var daysInYear = function(y) {
    return 365 + isLeapYear(y);
};

var convertDaysToDate = function() {
    var y = 0;
    var m = 0;
    var days = floor(totalDays);
    
    while (days &gt; daysInYear(_year + y)) {
        days -= daysInYear(_year + y);
        y++;
    }
    
    while (days &gt; daysInMonth(m)) {
        days -= daysInMonth(m);
        m++;
    }

    _day = days;
    _month = m;
    _year = y;
};

var updateOrbits = function() {
    for (var i = 1; i &lt; bodies.length; i++) {
        bodies[i].update();
    }
};

var changeDay = function(change) {
    totalDays = max(0, totalDays + change);
    convertDaysToDate();
    updateOrbits();
};

var getKM = function(d) {
    return round(10 * d) / 10;
};

var getMiles = function(d) {
    return round(10 * d / 1.6093) / 10;
};

/********************************************************
 *               GUI functions
*********************************************************/

var getDay = function() { return _day + 1; };
var getMonth = function() { return monthNames[_month]; };
var getYear = function() { return _year + startYear; };

// Convert current _day, _month, _year into total days since Jan 1st 2000
var updateDate = function() {
    totalDays = _day + 365 * _year;
    
    for (var y = 0; y &lt; _year; y+=4) {
        totalDays += isLeapYear(y + startYear);
    }
    for (var m = 0; m &lt; _month; m++) {
        totalDays += daysInMonth(m, y + startYear);
    }
    
    updateOrbits();
};


var setYear = function(self) {
    _year = floor(51 * self.val / (self.width + 1));
    updateDate();
};

var setMonth = function(self) {
    _month = floor(12 * self.val / (self.width + 1));
    updateDate();
};

var setDate = function(self) {
    var maxDays = daysInMonth(_month, _year + startYear);
    _day = floor(maxDays * self.val / (self.width + 1));
    updateDate();
};

var writeDate = function() {
    return getDay() + " " + (getMonth().slice(0, 3));
};

// Get to launch date
// Curiosity 26th Nov 2011
//_day = 26;
//_month = 10;
//_year = 2011;
//updateDate();
// changeDay(4312);

// Spirit 10th June 2003
//changeDay(1256);

/****************************************
 *          GUI objects
*****************************************/

var Slider = function(x, y, w, setF) {
    this.x = x;
    this.y = y;
    this.h = 16;
    this.width = w; 
    this.held = false;
    
    this.ballR = 12;
    this.ballD = this.ballR * 2;
    
    this.bx = this.x;
    this.val = 0;
    
    this.draw = function() {
        this.update();
        noStroke();
        fill(250, 250, 250, 120);
        rect(this.x-8, this.y - this.h/2, this.width + 16, this.h, 8);
    
        //fill(100, 100, 100, 120);
        //rect(this.x-8, this.y - this.h/2, this.width + 15, this.h - 1, 8);
    
        noStroke();
        fill(0, 0, 0, 100);
        ellipse(this.bx, this.y, this.ballD + 2, this.ballD + 2);
        fill(180);
        ellipse(this.bx, this.y, this.ballD, this.ballD);
        fill(255, 255, 255, 150);
        ellipse(this.bx - this.ballR * 0.3, this.y - this.ballR * 0.3, 5, 5);
    };
    
    this.selected = function() {
        this.held = dist(mouseX, mouseY, this.bx, this.y) &lt;= this.ballR;
    };
    
    this.update = function() {
        if (setF) {
            setF(this);
        }
    };
    
    this.drag = function() {
        if (this.held) {
            var x = constrain(mouseX, this.x, this.x + this.width);
            this.bx = x;
            this.val = x - this.x;
            this.update();
        }
    };
};

var Button = function(x, y, w, h, name, clickF) {
    this.x = x;
    this.y = y;
    this.w = w;
    this.h = h;
    this.name = name;
    this.defaultCol = color(217, 217, 217, 250);
    this.highlightCol = color(250, 50, 50, 250);
    this.showing = true;
    
    this.mouseover = function() {
        return (mouseX &gt;= this.x &amp;&amp; mouseX &lt;= this.x + this.w &amp;&amp;
                mouseY &gt;= this.y &amp;&amp; mouseY &lt;= this.y + this.h);
    };
    
    this.click = function() {

    };
    
    this.draw = function() {
        if (!this.showing) { return; }
        
        noStroke();
        if (this.mouseover() || this.selected) {
            fill(this.highlightCol);
        } else {
            fill(this.defaultCol);
        }
        rect(this.x, this.y, this.w, this.h, 12);
        
        fill(10);
        textSize(24);
        textAlign(CENTER, CENTER);
        text(this.name, this.x + this.w/2, this.y + this.h/2 - 1);
    };
};

var OptionBox = function(x, y, w, h, name, writeF, slider) {
    this.x = x;
    this.y = y;
    this.w = w;
    this.h = h;
    this.name = name;
    this.selected = false;
    
    this.draw = function() {
        noStroke();
        if (this.mouseover() || slider.held) {
            fill(200, 200, 200, 250);
        } else {
            fill(210, 210, 210, 150);
        }
        rect(this.x, this.y, this.w, this.h, 12);
        
        fill(0);
        textAlign(CENTER, BASELINE);
        textSize(16);
        text(this.name, this.x + this.w/2, this.y + this.h/2 - 1);
        
        textSize(13);
        text(writeF(), this.x + this.w/2, this.y + this.h - 4);
    };
    
    this.mouseover = function() {
        return (mouseX &gt;= this.x &amp;&amp; mouseX &lt;= this.x + this.w &amp;&amp;
                mouseY &gt;= this.y &amp;&amp; mouseY &lt;= this.y + this.h);
    };
    
};

var buttonX, buttonY, sliderX;

var createOptions = function() {
    var names = ['Date', 'Month', 'Year'];
    var setFunc = [setDate, setMonth, setYear];
    var writeFunc = [getDay, getMonth, getYear];
    
    var h = 32;
    var w = 72;
    var n = names.length;
    
    buttonY = n * (h + 4) - 90;
    buttonX = 6;
    sliderX = buttonX + w + 15;
    
    for (var i = 0; i &lt; n; i++) {
        var y = buttonY + (h + 4) * i;
        var s = new Slider(sliderX, y + 18, sliderW, setFunc[i]);
        var b = new OptionBox(buttonX, y, w, h, names[i], writeFunc[i], s);
        options.push(b);
        sliders.push(s);
    }

};

createOptions();
var launchButton = new Button(312, 132, 108, 28, "LAUNCH");
var retryButton = new Button(sunX - 36,  sunY + 50, 72, 28, "Retry");

/********************************************************
 *               Shuttle functions
*********************************************************/

// Launch shuttle
var launch = function() {
    var angle = atan2(earth.y, earth.x) + 360 * _hour / 24;
    
    // Find Earth's current speed by going forward a day
    var pos1 = earth.findPosition(totalDays);
    var pos2 = earth.findPosition(totalDays + 1);
    var dx = launchSpeed * cos(angle) + pos2[0] - pos1[0];
    var dy = launchSpeed * sin(angle) + pos2[1] - pos1[1];
    
    shuttles = new Shuttle(earth.x + dx, earth.y + dy, dx, dy);
    shuttles.launchDate = writeDate();
    
    var d = dist(shuttles.x, shuttles.y, mars.x, mars.y);
    minDist = d;
    oldDist = d;
    
    running = true;
    mode = "running";
};

// Check whether shuttle is close to Mars
var findOrbit = function() {
    var d = dist(mars.x, mars.y, shuttles.x, shuttles.y);
    if (d &lt; minDist) {
        minDist = d;
    }
    
    if (d &lt; 2) {
        running = false;
        mode = 'success';
    } else if (d &lt; 20 &amp;&amp; d &gt; oldDist) {
        mode = 'fly past';
    } else if (dist(0, 0, shuttles.x, shuttles.y) &gt; marsData.aperihelion * 1.2) {
        running = false;
        mode = 'fail';
    } else if (dist(earth.x, earth.y, shuttles.x, shuttles.y) &lt; 2) {
        //running = false;
        //mode = "crash";
    } else if (shuttles.daysInFlight &gt; 520) {
        running = false;
        if (mode !== 'fly past') {
            mode = 'time out';
        }
    }
    oldDist = d;
};

var reset = function() {
    mode = 'choice';
    running = false;
    changeDay(-shuttles.daysInFlight);
};

var writePosition = function(body) {
    var x = round(10000 * body.x) / 10000;
    var y = round(10000 * body.y) / 10000;
    return x + ", " + y;
};

/********************************************************
 *               Display functions
*********************************************************/
var drawEndState = function() {
    stroke(255);
    strokeWeight(2);
    fill(200, 200, 200, 200);
    var w = 210;
    var h = 80;
    rect(sunX - w/2, sunY - h/2, w, h, 5);
    strokeWeight(1);
    
    var title, sub1, sub2;
    switch(mode) {
        case 'success':
            title = "Mission successful!";
            sub1 = "Orbit achieved on: " + writeDate() + " " + (startYear + _year);
            sub2 = "Its journey took " + shuttles.daysInFlight + " days.";
            break;
        
        case 'fail':
            title = "Mission failed";
            sub1 = "Orbiter lost in space";
            break;
            
        case 'fly past':
            title = "Mission failed";
            sub1 = "Orbiter just missed Mars.";
            sub2 = "It got within " + getKM(minDist) + " million km.";
            break;
            
        case 'time out':
            title = "Mission failed";
            sub1 = "Orbiter missed Mars.";
            break;
    }
    
    fill(0);
    textSize(20);
    textAlign(CENTER, TOP);
    text(title, sunX, sunY - h/2 + 3);
    textAlign(LEFT, TOP);
    textSize(14);
    text(sub1, sunX - w/2 + 8, sunY - 5);
    if (sub2) {
        textAlign(CENTER, TOP);
        text(sub2, sunX, sunY +16);   
    }

};

var drawGraph = function() {
    var graphH = 100;
    var graphW = sliderW - 16;
    var graphX = sliderX + 20;
    var graphY = 121;
    
    var n = shuttles.distsToEarth.length;
    var maxX =  max(20, n);
    var maxY = ceil(shuttles.maxDist / 40) * 40;
    var dx = graphW / maxX;
    var dy = graphH / maxY;
    
    // Gridlines
    stroke(75);
    fill(255);
    textAlign(RIGHT, CENTER);
    textSize(9);
    for (var i = 0; i &lt;= 4; i++) {
        var y = graphY - i * graphH / 4;
        line(graphX, y, graphX + graphW, y);
        text(maxY * i/4, graphX - 2, y);
    }
    
    // Find x-axis label difference
    var tick = 5;
    while (n * 4 / tick &gt; 12) {
        tick *= 2;
    }
    
    stroke(255);
    textAlign(CENTER, TOP);
    for (var i = 0; i &lt; n * 4; i += tick) {
        var x = graphX + i * dx / 4;
        line(x, graphY, x, graphY + 2);
        text(i, x, graphY + 3);
    }
    
    // Labels
    textSize(12);
    text("Days since launch", graphX + graphW / 2, graphY + 12);
    textAlign(CENTER, BASELINE);
    text("Distance from satellite to planet", graphX + graphW / 2, graphY - graphH - 5);
    
    pushMatrix();
    translate(graphX - 20, graphY - graphH/2);
        rotate(270);
    text("millions of km", 0, 0);
    popMatrix();
    
    var earthY1 = graphY - shuttles.distsToEarth[0] * dy;
    var marsY1 = graphY - shuttles.distsToMars[0] * dy;
    var x = graphX;
    
    strokeWeight(2);
    for (var i = 1; i &lt; n; i++) {
        var earthY2 = graphY - shuttles.distsToEarth[i] * dy;
        var marsY2 = graphY - shuttles.distsToMars[i] * dy;
        
        stroke(earthData.colour);
        line(x, earthY1, x + dx, earthY2);
        stroke(marsData.colour);
        line(x, marsY1, x + dx, marsY2);
        
        x += dx;
        earthY1 = earthY2;
        marsY1 = marsY2;
    }
    
    // Axes
    strokeWeight(1);
    stroke(240);
    line(graphX, graphY, graphX + graphW, graphY);
    
};

var draw = function() {
    if (running) {
        changeDay(1);
        if (shuttles) {
            shuttles.update();   
        }
        findOrbit();
    }
    
    background(0);
    
    /*
    fill(255);
    textSize(14);
    textAlign(LEFT, BASELINE);
    text(totalDays, 20, 20);
    text(earth.n, 60, 20);
    text(_day + " " + _month, 20, 40);
    */
    
    noFill();
    if (showCycles) {
        var c = color(61, 100, 255, 90);
        earth.drawCycle(c);
        var c = color(212, 95, 17, 80);
        mars.drawCycle(c);
    }
    
    noStroke();
    for (var i in bodies) {
        bodies[i].draw();
    }
 
 /*
    var angle = atan2(earth.y - sunY, earth.x - sunX) + 360 * _hour / 24;
    var dx = launchSpeed * cos(angle) * 100;
    var dy = launchSpeed * sin(angle) * 100;
    stroke(255, 0, 0);
    line(earth.drawX, earth.drawY, earth.drawX + dx, earth.drawY + dy);
*/
 
    // GUI
    for (var i in options) { options[i].draw(); }
 
    if (mode === 'choice') {
        launchButton.draw();
        for (var i in sliders) { sliders[i].draw(); }

        noStroke();
        fill(0, 0, 0, 100);
        rect(buttonX - 4, buttonY - 60, 300, 22, 8);
        
        fill(TEXTCOL);
        textSize(15);
        textAlign(LEFT, BASELINE);
        text("Select the date to launch a satellite to Mars", buttonX + 5, 153);
        textAlign(CENTER, BASELINE);
        text("Mars", mars.drawX, mars.drawY - 8);
        text("Earth", earth.drawX, earth.drawY - 14);
    } else {
        shuttles.draw();
        retryButton.draw();
        drawGraph();
        
        /*
        fill(TEXTCOL);
        textSize(15);
        textAlign(LEFT, BASELINE);
        text("Satellite launched on " + shuttles.launchDate, buttonX, buttonY - 42);
        
        var d1 = getKM(dist(shuttles.x, shuttles.y, earth.x, earth.y));
        var d2 = getKM(dist(shuttles.x, shuttles.y, mars.x, mars.y));
        text(d1 + " million km from Earth.", buttonX, buttonY - 26);
        text(d2 + " million km from Mars.", buttonX, buttonY - 10);
        */
        
        if (mode !== "running") { drawEndState(); }
    }
    
};

/***************************************
 *               Event handling
****************************************/

var mousePressed = function() {
    if (mode === 'choice') {
        for (var s in sliders) {
            sliders[s].selected();
        }   
    }
};

var mouseReleased = function() {
    if (mode === "choice") {
        for (var s in sliders) {
            sliders[s].held = false;
        }
        if (launchButton.mouseover()) {
            launch();
        }
    } else {
        if (retryButton.mouseover()) {
            reset();
        }
    }
};

var mouseOut = function() {
    for (var s in sliders) {
        sliders[s].held = false;
    }
};

var mouseDragged = function() {
    if (mode === 'choice') {
        for (var s in sliders) {
            sliders[s].drag();
        }
    }
};

var keyPressed = function() {
    if (keyCode === 32) {
        if (mode === "running") {
            running = !running;   
        }
    }
    if (keyCode === 67) { showCycles = !showCycles; }
    if (keyCode === 83) {
        //launch();
    }
};
</pre></div></div></div></div></div><div class="clearfix"><div class="perseus-renderer perseus-renderer-responsive"><div class="paragraph" data-perseus-paragraph-index="0"><div class="paragraph">NASA engineers also need to figure out how to land objects onto planets. This simulation shows how tricky it is to successfully land a rover on Mars:</div></div><div class="paragraph" data-perseus-paragraph-index="1"><div class="paragraph"><div class="perseus-widget-container widget-nohighlight widget-block"><pre>/*************************************************
 * Can you guide Curiosity, the Mars Science
 * Laboratory (MSL) safely through entry,
 * descent and landing (EDL)?
 * 
 * Please note that while I've tried to make
 * this simulation as accurate as I can, I've
 * had to make a number of simplifications.
 * The correct parameters therefore do not
 * quite reflect the true parameters for EDL.
 * Always consult a trained rocket scientist
 * before attempting to land any equipment on
 * an alien planets. Landing craft may go down
 * as well as up.
 * 
 * To Do
 *  - Give feedback if mission fails
 *  - Improve heat equation
 *  - Animation of crashing/exploding
************************************************/

// Constants
var dragCoefficient;
var parachuteDrag = 121;
var landerDrag = 6;
var rocketPower = 12;           // m/s^2
var fuelUsage = 1;              // kg per m/s^2
var MARS_RADIUS = 3175;
var backshellMass = 20;         // kg
var wireLength = 7.8;           // m

// So many horrible global variables
var dt,
    time,
    position,
    oldPositions,
    speed,
    temperature,
    mass,
    fuel,
    fuelUsed;
var drag, velocity, acceleration, lift, density, angleOfAttack;
var result, mode, running, scorches, xOffset;
var backshellPos, backshellVel, roverPos;
var divY, divDY;

var events,
    eventTimer,
    sufr,
    parachute,
    parachuteLength,
    parachuteGrowth,
    heatshield,
    peakTemp,
    peakDrag,
    backshell,
    retrorockets,
    constDeceleration,
    skyCrane,
    craneLength,
    snatch,
    touchdown;

var resetParameters = function() {
    dt = 0.2;                   // s
    time = 0;                   // s
    position = [0, 131000];     // m
    speed = 5800;               // m/s
    acceleration = [0, 0];      // m/s^2
    temperature = 5;            // K
    mass = 3690;                // kg
    fuel = 391;                 // kg
    dragCoefficient = 8;
    xOffset = 0;
    running = true;
    mode = 'choice';
    
    scorches = [];
    oldPositions = [position];
    
    // Events
    events = [];
    eventTimer = false;
    sufr = false;
    parachute = 'stowed';
    heatshield = true;
    peakTemp = false;
    peakDrag = false;
    backshell = true;
    retrorockets = false;
    constDeceleration = false;
    backshellPos = false;
    roverPos = false;
    skyCrane = false;
    snatch = false;
    touchdown = false;
    craneLength = 0;
    parachuteLength = 0;
    parachuteGrowth = 1;
    divY = 180;
    divDY = 0;
};
resetParameters();

// Display Parameters
var impFont = createFont("Arial", 40);
var sansFont = createFont("sans", 40);
var monoFont = createFont("monospace", 40);
var BLACK = color(0);

var ground = [];
var ground2 = [];
for (var i=0; i&lt;25;i++) {
    if (i &lt; 15) {
        ground2.push(random(90, 110)/100);   
    }
    ground.push(random(85, 115)/100);
}

/*************************************************
 *    GUI Objects
*************************************************/

var Slider = function(x, y, w, min_v, max_v, current_v) {
    this.x = x;
    this.y = y;
    this.width = w;
    this.min = min_v;
    this.max = max_v;
    this.scale = (max_v - min_v) / w;
    this.val = current_v === undefined ? min_v : current_v;
    this.bx = this.x + (this.val - min_v) / this.scale;
    
    this.held = false;

    this.draw = function() {
        noStroke();
        fill(200);
        rect(this.x, this.y-1, this.width+2, 3, 4);
        
        strokeWeight(1);
        stroke(60);
        line(this.x + 1, this.y-1, x + this.width, this.y);
    
        fill(180);
        stroke(50);
        rect(this.bx, this.y-8, 10, 16, 3);
        
        for (var i=0; i&lt;3; i++) {
            var y = this.y + i*3 - 3;
            stroke(50);
            line(this.bx + 3, y, this.bx + 7, y); 
            stroke(200);
            line(this.bx + 3, y+1, this.bx + 7, y+1); 
        }
    };
    
    this.selected = function() {
        this.held = mouseX &gt; this.bx - 1 &amp;&amp; mouseX &lt; this.bx + 11 &amp;&amp; 
                    mouseY &gt; this.y - 9 &amp;&amp; mouseY &lt; this.y + 9;
    };
    
    this.drag = function() {
        if (this.held) {
            var x = constrain(mouseX, this.x, this.x + this.width);
            this.bx = x;
            this.val = this.min + (x - this.x) * this.scale;
        }
    };
    
    this.update = function(d) {
        this.val = constrain(this.val + d, this.min, this.max);
        this.bx = (this.val - this.min) / this.scale + this.x;
    };
};

var Button = function(x, y, w, h, name, clickF) {
    this.x = x;
    this.y = y;
    this.w = w;
    this.h = h;
    this.name = name;
    this.defaultCol = color(180, 180, 180);
    this.highlightCol = color(250, 60, 60);
    this.clickF = clickF;
    this.showing = true;
    
    this.mouseover = function() {
        return mouseX &gt;= this.x &amp;&amp; mouseX &lt;= this.x + this.w &amp;&amp; 
               mouseY &gt;= this.y &amp;&amp; mouseY &lt;= this.y + this.h;
    };
    
    this.click = function() {
        if (this.showing &amp;&amp; this.mouseover()) {
            if (this.clickF) {
                this.clickF();
                return true;
            }
        }
    };
    
    this.draw = function() {
        if (!this.showing) { return; }
        
        noStroke();
        if (this.mouseover()) {
            fill(this.highlightCol);
        } else {
            fill(this.defaultCol);
        }
        rect(this.x, this.y, this.w, this.h, 8);
        
        fill(10);
        textFont(impFont, 28);
        textAlign(CENTER, CENTER);
        text(this.name, this.x + this.w/2, this.y + this.h/2);
    };
};

var writeTime = function(t) {
    var minutes = floor(t / 60);
    var seconds = t % 60;
    var t = minutes + ":";
    if (floor(seconds) &lt; 10) { t += '0'; }
    return t + floor(seconds);
};

// Add comma to number so 15001 becomes 15,001
var addComma = function(n) {
    if (n &lt; 1000) { return n; }
    var thousands = floor(n/1000);
    var hundreds = n % 1000;
    if (hundreds &lt; 10) { hundreds = '00' + hundreds; }
    else if (hundreds &lt; 100) { hundreds = '0' + hundreds; }
    return thousands + "," + hundreds;
};

var writeDegrees = function(d) { return round(100 * d) /100  +""; };
var writeSpeed = function(d) { return round(d*25)  +" m/s"; };
var writeAltitude = function(d) { return d  +" m"; };

/*******************************************************
 *      Parameters that we get to choose
*******************************************************/
var parameters = {
    "Angle of attack": {
        min: 5,
        max: 85,
        func: writeDegrees,
        details: "Angle at which MSL enters the atmosphere relative to the surface. Therefore 90 represents travelling straight down."
    },
    "SUFR": {
        min: 0,
        max: 240,
        func: writeSpeed,
        details: "Velocity below which MSL executes Straighten Up and Fly Right. This maneuver reorients the MSL to avoid lift and aligns the landing sensor."
    },
    "Parachute": {
        min: 0,
        max: 720,
        func: writeTime,
        details: "Time at which the parachute is deployed. The parachute can withstand speeds up to Mach 2.2 (750 m/s)."
    },
    "Heatshield": {
        min: 0,
        max: 720,
        func: writeTime,
        details: "Time at which the heatshield is jettisoned. Sensors can then be activated, allowing MSL to measure its altitude. The MSL must be travelling at a sub-sonic speed &lt;340 m/s."
    },
    "Backshell": {
        min: 0,
        max: 8000,
        func: writeAltitude,
        details: "Altitude at which the backshell with the parachute is detached. The heatshield must be jettisoned before accurate alititude measurements can be made."
    },
    "Freefall": {
        min: 0,
        max: 40,
        func: writeTime,
        details: "Time that MSL spends in freefall after backshell (with parachute) separates and before the retrorockets fire."
    },
    "Constant velocity": {
        min: 0,
        max: 800,
        func: writeAltitude,
        details: "Height by which the MSL aims to reach a constant velocity."
    },
    "Skycrane": {
        min: 0,
        max: 160,
        func: writeAltitude,
        details: "Height at which the MSL starts to descend from the MSL the skycrane."
    }
};

var sliders = [];
var sliderY = 75;
var sliderDY = 30;

for (var p in parameters) {
    var para = parameters[p];
    var s = new Slider(210, sliderY, 160, para.min, para.max);
    para.slider = s;
    sliders.push(s);
    sliderY += sliderDY;
}

var startEntry = function() {
    mode = "running";
    angleOfAttack = sliders[0].val;
    velocity = [speed * cos(angleOfAttack), -speed * sin(angleOfAttack)];
};

var buttons = [
    new Button(232, 353, 149, 32, "Start Entry!", startEntry),
    new Button(240, 353, 140, 32, "Abort", resetParameters),
    new Button(240, 353, 140, 32, "Try again!", resetParameters)
];
buttons[1].showing = false;
buttons[2].showing = false;

/*************************************************
 *    Physics functions
*************************************************/

var calculateAtmosphericDensity = function(altitude) {
    var h = altitude / 11100;   // scale height 11.1 km
    return 20000 / exp(h);
};

var calculateDrag = function(speed, density) {
    var s = speed / 1000;
    return dragCoefficient * density * s * s;
};

// What is the constant deceleration required to reach a given
// vertical velocity by the time we reach a given height?
var calculateDecleration = function(targetSpeed, targetHeight) {
    var s = -velocity[1];
    var t = 2 * (position[1] - targetHeight) / (targetSpeed + s);
    return max(0, (s - targetSpeed) / t);
};

/*************************************************
 *    Events
*************************************************/

// Test to see if events have occurred
// Shouldn't need to test each one every time
var updateEvents = function() {
    if (position[1] &gt; 50000 &amp;&amp; velocity[1] &gt; 0) {
        mode = 'end';
        result  = "Skimming away!";
        return;
    }
    
    if (position[1] &lt; 2) {
        position[1] = 0;
        mode = 'end';
        if (fuel &lt; 1) {
            result = "Insufficient fuel!";
        } else {
            result  = "Crash!";   
        }
        return;
    }
    
    if (position[1] &lt; 5 &amp;&amp; retrorockets &amp;&amp; velocity[1] &gt; -1) {
        mode = 'end';
        result = "Dust damage!";
        return;
    }
    
    // SUFR
    if (!sufr &amp;&amp; speed &lt; sliders[1].val * 25) {
        sufr = true;
        mass -= 150;
        events.push([time, "SUFR executed", false]);
    }
    
    // Parachute
    if (parachute === 'stowed' &amp;&amp; time &gt; sliders[2].val) {
        if (speed &lt; 750) {
            parachute = 'deployed';
            dragCoefficient = parachuteDrag;
            events.push([time, "Parachute deployed", false]);
            dt /= 2;
        } else {
            parachute = 'destroyed';
            mass -= 100;
            events.push([time, "Parachute destroyed", true]);
        }
    }
    
    // Heatshield
    if (heatshield &amp;&amp; time &gt; sliders[3].val) {
        heatshield = false;
        mass -= 440;
        if (position[1] &gt; 18000) {
            events.push([time, "Heatshield jettisoned", true]);
        } else {
            events.push([time, "Heatshield jettisoned", false]);
        }
    }
    
    // Backshell seperation
    if (backshell &amp;&amp; sufr &amp;&amp; !heatshield &amp;&amp; 
        position[1] &lt; sliders[4].val) {
        backshell = false;
        backshellPos = [position[0], position[1]];
        backshellVel = [velocity[0], velocity[1]];
        if (parachute === 'destroyed') {
            mass -= 100;   
        } else {
            mass -= 200;
        }
        parachute = false;
        dragCoefficient = landerDrag;
        eventTimer = time;
        events.push([time, "Backshell separated", false]);
    }
    
    // Retrorockets on - reduce velocity by the time we reach
    // a certain height
    if (!skyCrane &amp;&amp; eventTimer &amp;&amp; time-eventTimer &gt; sliders[5].val) {
        if (sliders[5].val === 0) {
            mode = "end";
            result = "Collision!";
        }
        eventTimer = false;
        retrorockets = 'initial';
        dt /= 2;
        events.push([time, "Retrorockets engaged", false]);
        constDeceleration = calculateDecleration(20, sliders[6].val);
        /*
        println(round(position[1]) + " m to " + round(sliders[6].val) +  "m");
        println(round(speed) + " m/s to 20 m/s");
        println(round(constDeceleration*10)/10 + " m/s^2");
        */
    }
    
    // Retrorockets to constant velocity
    if (retrorockets === 'initial' &amp;&amp; position[1] &lt; sliders[6].val) {
        retrorockets = 'const velocity';
        events.push([time, "Constant velocity", false]);
    }
    
    // Retrorockets to constant deceleration
    if (retrorockets === 'const velocity' &amp;&amp; position[1] &lt; 55) {
        retrorockets = 'const deceleration';
        constDeceleration = calculateDecleration(0.75, 21);
        events.push([time, "Constant deceleration", false]);
    }
    
    // Retrorockets to constant deceleration
    if (retrorockets === 'const deceleration' &amp;&amp; velocity[1] &gt; -0.8) {
        retrorockets = 'const velocity 2';
    }
    
    // Start sky crane
    if (!skyCrane &amp;&amp; !backshell &amp;&amp; position[1] &lt; sliders[7].val) {
        skyCrane = true;
    }
    
    // Sky crane maneuver 
    if (skyCrane) {
        if (craneLength === 0) {
            divDY = 15;
            dt /= 2;
            eventTimer = time;
            events.push([time, "Rover separation", false]);
        }
        
        // Lengthen crane if we still have length
        if (craneLength &lt; wireLength) {
            craneLength += dt * 1.1;   
        }
        
        if (!snatch &amp;&amp; time - eventTimer &gt; 7) {
            snatch = true;
            divDY = 15;
            events.push([time, "Snatch (wheels down)", false]);
        }
        
        // Touchdown - wait 2 seconds to unhitch
        if (!touchdown &amp;&amp; position[1] - craneLength &lt; 1) {
            if (velocity[1] &lt; -2 || !snatch) {
                mode = 'end';
                result  = "Heavy landing!";
                return;
            }
            
            touchdown = true;
            eventTimer = time;
            divDY = 15;
            events.push([time, "Touchdown", false]);
        }
        
        // Flyaway if we have touched down for 2 seconds
        if (touchdown &amp;&amp; retrorockets !== 'flyaway' &amp;&amp;
            time - eventTimer &gt;= 2) {
            retrorockets = 'flyaway';
            eventTimer = time;
            divDY = 15;
            events.push([time, "Fly away", false]);
        }
        
        // Success
        if (retrorockets === 'flyaway' &amp;&amp; fuel &gt; 0 &amp;&amp;
            time - eventTimer &gt;= 8) {
            mode = 'end';
            result = "Mission successful";
        }
    }
};

var calculateBackshellPosition = function() {
    backshellPos[0] += backshellVel[0] * dt;
    backshellPos[1] += backshellVel[1] * dt;
    
    var angle = atan2(backshellVel[1], backshellVel[0]);
    var BSspeed = dist(0, 0, backshellVel[0], backshellVel[1]);
    var dragMag = calculateDrag(BSspeed, 
        calculateAtmosphericDensity(position[1])) / backshellMass;
    
    backshellVel[0] -= dragMag * cos(angle) * dt;
    backshellVel[1] -= dragMag * sin(angle) * dt;
    backshellVel[1] -= 42700000 / pow(MARS_RADIUS + 
                            backshellPos[1] / 1000, 2);
};

var calculatePosition = function() {    
    position[0] += velocity[0] * dt;
    position[1] += velocity[1] * dt;
    
    if (round(time * 10) % 20 === 0) {
        oldPositions.push([position[0], position[1]]);
    }
    
    var velocityAngle = atan2(velocity[1], velocity[0]);
    density = calculateAtmosphericDensity(position[1]);
    var gravity = 42700000 / pow(MARS_RADIUS + position[1]/1000, 2);
    var dragMag = calculateDrag(speed, density) / mass;
    
    // Calculate whether deceleration has peaked
    if (!peakDrag &amp;&amp; dragMag &gt; 10 &amp;&amp;
        dragMag &lt; dist(0, 0, drag[0], drag[1])) {
        peakDrag = true;
        events.push([time, "Peak decel. " + round(dragMag / 0.981)/10 + " G", false]);
    }
    
    if (retrorockets) { angleOfAttack = 90; }
    else if (sufr) { angleOfAttack = -velocityAngle; }
    
    var c = cos(velocityAngle);
    var s = sin(velocityAngle);
    drag = [-dragMag * c, -dragMag * s];
    fuelUsed = 0;
    
    if (!sufr) {
        var liftToDrag = 0.24 * (90 - angleOfAttack) / 74;
        var liftMag = liftToDrag * dragMag;
        if (round(time/4) % 2 === 0) {
            liftMag += 8;
        }
        lift = [-liftMag * s, liftMag * c];
    } else if (retrorockets) {
        drag = [0, 0];

        switch (retrorockets) {
            case 'initial':
                // Get to 20 m/s
                lift = [0, min(12, constDeceleration + gravity)];
                break;
             case 'const velocity':
                lift = [-velocity[0]/2, gravity];
                break;
            case 'const deceleration':
                lift = [0, min(12, constDeceleration + gravity)];
                break;
            case 'const velocity 2':
                lift = [-velocity[0]/2, gravity];
                break;
            case 'flyaway':
                lift = [0.5, gravity + 1];
                break;
        }
        
        fuelUsed = max(0, fuelUsage * (lift[0] + lift[1]) * dt);
        fuel -= fuelUsed;
        if (fuel &lt; 0) {
            mass -= fuelUsed;
            fuel = 0;
            lift = [0, 0];
        }
    } else {
        lift = [0, 0];
    }

    acceleration = [lift[0] + drag[0], lift[1] + drag[1] - gravity];
    velocity[0] += acceleration[0] * dt;
    velocity[1] += acceleration[1] * dt;
    speed = mag(velocity[0], velocity[1]);

    //temp = 5 + (temp - 5 + speed * density/550 * dt) * 0.35;
    var newTemp = 5 + density*(0.0125 + pow(speed, 1.2) / 40000);
    if (!peakTemp &amp;&amp; newTemp &gt; 500 &amp;&amp; newTemp &lt; temperature) {
        peakTemp = true;
        events.push([time, "Peak temp. " +round(temperature) + " K", false]);
    }
    
    temperature = newTemp;
    if ((heatshield &amp;&amp; temperature &gt; 10000) ||
        (!heatshield &amp;&amp; temperature &gt; 400)) {
        mode = "end";
        result = "Curiosity Overheated!";
    }
    
    if (backshellPos) {
        calculateBackshellPosition();
    }
    
    if (skyCrane &amp;&amp; !touchdown) {
        roverPos = [position[0], max(0, position[1] - craneLength)];
    }
};

/*************************************************
 *    Display functions
*************************************************/
var drawParameterChoice = function() {    
    fill(255);
    textFont(impFont, 28);
    textAlign(CENTER, BASELINE);
    var titleY = 48;
    var txt = "Curiosity Landing Parameters";
    text(txt, 200, titleY);
    
    stroke(255);
    strokeWeight(1);
    line(195 - textWidth(txt)/2, titleY + 3,
         205 + textWidth(txt)/2, titleY + 3);
    
    var tx = 20;    
    textAlign(LEFT, BASELINE);
    
    for (var p in parameters) {        
        var slider = parameters[p].slider;
        var ty = slider.y + 7;
        slider.draw();
        
        fill(250);
        textFont(impFont, 18);
        txt = p + ":  " + parameters[p].func(slider.val);
        text(txt, tx, ty);
        
        // Mouse over text
        if (mouseY &lt;= ty + 8 &amp;&amp; mouseY &gt; ty - sliderDY + 8) {
            fill(250);
            textFont(sansFont, 12);
            text(parameters[p].details, 25, 308, 350, 200);
        }
    }

    buttons[0].draw();
    buttons[0].showing = true;
    buttons[1].showing = false;
    buttons[2].showing = false;
};

var logEvents = function() {
    stroke(225);
    fill(0);
    //rect(0, divY, 400, 400-divY);
    line(0, divY, 400, divY);

    textFont(sansFont, 13);
    textAlign(CENTER, BASELINE);    
    fill(255);
    text("Time: " + writeTime(time), 90, 23);

    textFont(monoFont, 11);
    textAlign(LEFT, BASELINE);
    
    var tx = 12;
    var ty = 40;
    for (var e in events) {
        var evt = events[e];
        fill(255);
        var txt = writeTime(evt[0]) + " ";
        text(txt, tx, ty);
        
        if (evt[2]) {
            var p = (frameCount % 10) / 10;
            fill(lerpColor(color(255,0,0), color(0,0,0), p));
        } else {
            fill(230);
        }
        text(evt[1], tx + textWidth(txt), ty);
        ty += 15;
    }
};

var drawShape = function(x, y, dx, dy) {    
    beginShape();
    vertex(x - dx[0], y + dy[0]);
    bezierVertex(x-dx[1],y+dy[1], x+dx[1], y+dy[1], x+dx[0], y+dy[0]);
    vertex(x + dx[2], y + dy[2]);
    bezierVertex(x-dx[3],y+dy[3], x+dx[3], y+dy[3], x-dx[2], y+dy[2]);
    vertex(x - dx[0], y + dy[0]);
    endShape();
};

var drawCuriosity = function() {    
    var x = 0;
    var y = 0;
    var dx = [11, 21, 70, 124, 124, 10];
    var dy = [-78, -62, -44, 16, 27, 63];
    var bx = [0, 3, 12, 0, -6, 5];
    var by = [-80, -64, -50, 25, 40, 65];
    var cols = [color(240, 240, 240),
                color(200, 200, 200),
                color(160, 160, 160),
                color(30, 30, 30),
                color(77, 44, 9)];

    // Landing radar
    if (!heatshield) {
        noFill();
        strokeWeight(6);
        
        for (var i = 0; i &lt; 4; i++) {
            var d = (frameCount + i * 12) % 48;
            var c = lerpColor(color(45, 64, 245, 0), color(45, 64, 245, 255), 1 - d/50);
            stroke(c);
            arc(x, y + 10 + d * 2, d * 5.6, d * 4, 30, 150);   
        }
    }

    var n = heatshield ? dx.length - 1 : dx.length - 2;
    
    beginDraw();
    strokeWeight(1);
    stroke(10);
    for (var i=0; i&lt;n; i++) {
        fill(cols[i]);
        stroke(cols[i]);
        var xs = [dx[i], bx[i], dx[i + 1], bx[i + 1]];
        var ys = [dy[i], by[i], dy[i + 1], by[i + 1]];
        drawShape(x, y, xs, ys);  
    }
    endDraw();
    
    noStroke();
    fill(40);
    ellipse(23, -55, 9, 5);
    ellipse(-86, 8, 6, 9);
    ellipse(-72, 9, 7, 9);
    ellipse(-57, 10, 7, 9);
    
    // Scorching
    strokeWeight(3);
    stroke(36, 20, 10, 50);
    for (var i=0; i&lt;scorches.length; i++) {
        var theta = scorches[i][0];
        var r = scorches[i][1];
        var c = cos(theta);
        var s = sin(theta);
        var x1 = s*200;
        var y1 = c*38 - 14;
        var a = atan2(y1 - (-9 - c*34), x1 - s*130);
        line(x1, y1, x1-r*cos(theta-a), y1-r*sin(theta+a));
    }
    
    // Exhaust
    if (!sufr &amp;&amp; round(time/4) % 2 === 0) {
        strokeWeight(2);
        stroke(255, 255, 255, 100);
        for (var i=0; i&lt;10; i++) {
            var theta = 304 + random(-10, 10);
            var d = 10 + random(20);
            line(23, -55, 23 + d * cos(theta), -55 + d * sin(theta));
        }
    }

    if (parachute === 'deployed') {
        fill(200);
        noStroke();
        rect(x-2, y-140, 3, 60);
        strokeWeight(1);
        stroke(200);
        line(x, y-140, x+20, y-800);
        line(x, y-140, x-20, y-800);
        line(x, y-140, x+50, y-800);
        line(x, y-140, x-50, y-800);
        line(x, y-140, x+70, y-800);
        line(x, y-140, x-70, y-800);
    }
};

var drawDescentStage= function(x, y) {
    var w = 110;
    var h = 60;
    noStroke();
    fill(120);
    rect(x-w/2, y-h/2, w, h);
    
    fill(230);
    ellipse(x-w/2-3, y+4, 26, 46);
    ellipse(x+w/2+3, y+4, 26, 46);
    
    var n = round(20 * fuelUsed);
    
    noStroke();
    // Thruster 1
    pushMatrix();
    translate(x-w/2-32, y+48);
    rotate(10);
        // Gas
        fill(250, 195, 125, 80);
        for (var i = 0; i &lt; n; i++) {
            ellipse(0, 0, 6, random()*(n*5+40));
        }
        
        // Thruster
        fill(100);
        arc(0, -1, 9, 30, -180, 0);
        fill(80);
        rect(-4, -30, 8, 16);
    popMatrix();
    
    // Thruster 2
    pushMatrix();
    translate(x+w/2+32, y+48);
    rotate(-10);
        // Gas
        fill(250, 195, 125, 80);
        for (var i = 0; i &lt; n; i++) {
            ellipse(0, 0, 6, random()*(n*5+40));
        }
        
        // Thruster
        fill(100);
        arc(0, -1, 9, 30, -180, 0);
        fill(80);
        rect(-4, -30, 8, 16);
    popMatrix();
    
    // Central circle
    fill(200);
    strokeWeight(3);
    stroke(40);
    ellipse(x, y, 40, 40);
    noStroke();
    fill(240);
    ellipse(x-5, y-5, 5, 5);
    
    // Triangular fins
    strokeWeight(1);
    stroke(40);
    fill(180);
    quad(x-w/2+25, y-h/2+1, x-w/2-32, y+10,
         x-w/2-32, y+18, x-w/2+25, y+h/2-1);
    quad(x+w/2-25, y-h/2+1, x+w/2+32, y+10,
         x+w/2+32, y+18, x+w/2-25, y+h/2-1);
    
    stroke(80);
    strokeWeight(3);
    line(x-w/2+24, y-h/2+6, x-6, y+h/2-5);
    line(x+w/2-24, y-h/2+6, x+6, y+h/2-5);
    
    stroke(30);
    line(x-w/2+24, y-h/2+6, x+w/2-24, y-h/2+6);
    
    stroke(80);
    strokeWeight(1);
    rect(x-w/2+22, y+h/2-6, w-44, 4);
};

var drawArrow = function(x, y, dx, dy, fCol, sCol, _scale) {
    var magnitude = dist(0, 0, dx, dy);
    var arrowSize = sqrt(magnitude);
    if (_scale) { arrowSize *= _scale; }
    if (arrowSize &lt; 1) { return; }
    var arrowLength = arrowSize*2;
    var arrowWidth = ceil(arrowSize/8);

    fill(fCol);
    noStroke();
    translate(x, y);
    rotate(270 - atan2(dy, dx));
    rect(-arrowWidth, 0, arrowWidth*2, arrowLength);
    triangle(-arrowWidth*2, arrowLength-1, arrowWidth*2, arrowLength-1, 0, arrowLength + arrowWidth*3);
    
    stroke(sCol);
    line(-arrowWidth, 0, -arrowWidth, arrowLength-1);
    line(arrowWidth, 0, arrowWidth, arrowLength-1);
    line(-arrowWidth, arrowLength-1, -arrowWidth*2, arrowLength-1);
    line(arrowWidth, arrowLength-1, arrowWidth*2, arrowLength-1);
    line(-arrowWidth*2, arrowLength-1, 0, arrowLength + arrowWidth*3+1);
    line(arrowWidth*2, arrowLength-1, 0, arrowLength + arrowWidth*3+1);
    resetMatrix();
};

// Vector quantities (lift, deceleration, velocity)
var drawVectorMagnitudes = function() {
    var decel = dist(0, 0, acceleration[0], acceleration[1]);
    var liftS = dist(0, 0, lift[0], lift[1]);
    var ty = 352;
    var txt;
    
    textFont(sansFont, 12);
    textAlign(LEFT, BASELINE);
    
    if (liftS !== 0) {
        txt = "Lift: " + round(liftS)/10 + " m/s";
        var dx = textWidth(txt);
        fill(20, 160, 20);
        text(txt, 18, ty);
        textFont(sansFont, 7);
        text("2", 19+dx, ty - 7);   
    }
    
    textFont(sansFont, 13);
    fill(240, 50, 50);
    txt = "Deceleration: " + round(decel)/10 + " m/s";
    var dx = textWidth(txt);
    text(txt, 18, ty + 16);
    textFont(sansFont, 7);
    text("2", 19 + dx, ty + 9);
    textFont(sansFont, 13);
    text("(" + round(decel/0.981)/10 + " G)", 28 + dx, ty + 16);
    
    fill(80, 80, 240);
    if (speed &gt; 10) {
        text("Velocity: " + round(speed) + " m/s", 18, ty + 32);
    } else if (speed &gt; 1){
        text("Velocity: " + round(speed*10)/10 + " m/s", 18, ty + 32);
    } else {
        text("Velocity: " + round(speed*100)/100 + " m/s", 18, ty + 32);
    }
};

var drawFuel = function() {
    var x = 60;
    var y = 325;
    
    stroke(250);
    if (fuel &lt; 100) {
        var p = (frameCount % 10) / 10;
        fill(lerpColor(color(100,0,0), color(0,0,0), p));   
    } else {
        fill(0);    
    }
    
    strokeWeight(1);
    arc(x, y, 80, 70, 180, 360);
    for (var i=180; i&lt;=360; i+=45) {
        line(x+36*cos(i), y+31.5*sin(i), x+40*cos(i), y+35*sin(i));
    }
    
    stroke(220, 30, 30, 180);
    strokeWeight(2);
    var theta = 180 + 180 *(fuel/391);
    line(x, y, x + 36 * cos(theta), y + 31.5 * sin(theta));

    strokeWeight(1);
    stroke(255);
    fill(0);
    ellipse(x, y, 3, 3);
    
    textAlign(CENTER, TOP);
    fill(255);
    textFont(sansFont, 9);
    text("Fuel: " + round(fuel) + " kg", x, y - 16);
};

var drawVectors = function() {
    fill(255);
    textFont(impFont, 18);
    textAlign(LEFT, BASELINE);
    
    var decel = dist(0, 0, acceleration[0], acceleration[1]);
    var liftS = dist(0, 0, lift[0], lift[1]);
    var cx = 200;
    var cy = (height + divY) / 2 - 10;
    var shake = constrain(decel/50, 0, 5) * sin(time*800);
    cx += shake * sin(angleOfAttack);
    cy += shake * cos(angleOfAttack);
    
    noStroke();
    translate(cx, cy);

    if (backshell) {
        rotate(270 + angleOfAttack);
        scale(0.4, 0.4);
        drawCuriosity();
        noStroke();
        var p = constrain((temperature - 400)/2500, 0, 1);
        for (var i=0; i&lt;round(100 * p); i++) {
            fill(lerpColor(color(225, 0, 0, 5),
                           color(255, 245, 245, 8), p));
            arc(0, 32-i, 250+i*2, 85, 0, 180);
        }
        if (running &amp;&amp; random() &lt; p) {
            var theta = random(-38, 37);
            var d = random(2, 8) * random(2, 5);
            scorches.push([theta, d]);
        }
    } else {
        var p = constrain(liftS, 0, 5);
        rotate(p * sin(time * p));
        scale(0.6, 0.6);
        drawDescentStage(0, 0);
    }
    
    resetMatrix();
    
    strokeWeight(2);
    drawArrow(cx, cy, velocity[0], velocity[1],
              color(80, 80, 240, 220), color(34, 34, 181));
    drawArrow(cx, cy, drag[0], drag[1],
              color(240, 50, 50, 200), color(191, 17, 17), 4);
    drawArrow(cx, cy, lift[0], lift[1],
              color(20, 160, 20, 200), color(5, 107, 5), 3);
    
    // Temperature stats
    var tx = 246;
    textFont(sansFont, 11);
    textAlign(LEFT, BASELINE);
    fill(255);
    
    var txt = "Temperature: " + round(temperature) + " K";
    text(txt, tx, divY + 44);
    
    // Line to heatshield
    stroke(100);
    strokeWeight(1);
    line(tx, divY + 48, tx + textWidth(txt) + 2, divY + 48);
    
    var hx, hy;
    if (heatshield) {
        hx = cx + 24 * cos(angleOfAttack - 42);
        hy = cy + 24 * sin(angleOfAttack - 42);
    } else {
        hx = cx + 28 * cos(angleOfAttack - 110);
        hy = cy + 28 * sin(angleOfAttack - 110);
    }
    // Reduce shaking a bit
    hy = 5 * round(hy / 5);
    
    line(tx + textWidth(txt)/2, divY + 48, tx + textWidth(txt)/2, hy);
    line(tx + textWidth(txt)/2, hy, hx, hy);
    
    text("Air temperature: " + round(5+density*0.0125) + " K", tx, divY + 30);
    txt = "Atmosphere: " + round(density)/1000 + " g/m";
    text(txt, tx, divY + 16);
    tx += textWidth(txt);
    textFont(sansFont, 7);
    text("3", tx, divY + 9);
    
    drawVectorMagnitudes();
    drawFuel();
    buttons[1].showing = true;
    buttons[1].draw();
};

var drawBackshell = function(x, y, w) {
    var top = -w/3;
    translate(x, y);
    rotate(270 + angleOfAttack);
    if (!backshell || parachute === 'deployed') {
        if (parachuteLength &lt; 35) {
            parachuteLength += parachuteGrowth;
            parachuteGrowth++;
        }
        var s = w * parachuteLength / 36;
        var parachuteY = top - 4 * s;
        stroke(255, 255, 255, 180);
        line(0, top, 0, parachuteY);
        line(0, top - s/2, -s, parachuteY);
        line(0, top - s/2, s, parachuteY);
        line(0, top - s/2, -s/2, parachuteY);
        line(0, top - s/2, s/2, parachuteY);
        fill(255, 255, 255, 180);
        arc(0, parachuteY, s * 2, s * 2.5, 180, 360);
    }
    
    if (heatshield) {
        noStroke();
        fill(87, 54, 13);
        triangle(w/2+2, 0, -w/2-2, 0, 0, w/4);
    }

    stroke(100);
    fill(180);
    quad(-w/4, top, w/4, top, w/2+1, 0, -w/2-1, 0); 
    resetMatrix();
};

var drawGround = function(points, h) {
    var s = 400 / (points.length - 1);
    beginShape();
        vertex(0, divY);
        vertex(0, divY - h);
        for (var i=0; i&lt;points.length; i++) {
            curveVertex((i + 1) * s, divY - h * points[i]);
        }
        vertex(400, divY - h);
        vertex(400, divY);
        vertex(400, divY);
        vertex(0, divY);
        vertex(0, divY);
    endShape();
};

// Draw small rover image
var drawRover = function(x, y, w, mag) {
    stroke(100);
    fill(200);
    rect(x - w/2 + 2, y - w/5, w/2 + w/5, w/4);
    quad(x + w/5 + 2, y - w/5,
         x + w/5 + 2, y + w/4 - 5,
         x + w/2, y + w/4 - 6,
         x + w/2, y - w/4);
    
    var wheels = y + 3 - mag/2-1;
    var wx1 = x - w/2 + 1;
    var wx2 = x + w/2;
    var wx3 = x + 1;
    
    if (snatch) {
        stroke(30);
        strokeWeight(2);
        wheels += 7;
        line(x - w/5, y, wx1, wheels - 4);
        line(x - w/5, y, x + w/4, y + 4);
        line(x + w/4, y + 4, wx2, wheels - 4);
        line(x + w/4, y + 4, wx3, wheels - 4);
    }
    
    stroke(20);
    strokeWeight(2);
    noFill();
    ellipse(wx1, wheels, 7-mag, 7-mag);
    ellipse(wx2, wheels, 7-mag, 7-mag);
    ellipse(wx3, wheels, 7-mag, 7-mag);
    noStroke();
    fill(100);
    ellipse(wx1, wheels, 3, 3);
    ellipse(wx2, wheels, 3, 3);
    ellipse(wx3, wheels, 3, 3);
};

var drawSideView = function() {
    // Calculate scaling
    var maxHeight, xPos;
    if (touchdown) {
        xPos = roverPos[0];
        maxHeight = (roverPos[1] + wireLength) * 2.5;
    } else {
        xPos = position[0];
        maxHeight = min(150000, max(4, position[1]) * 2.5);
        
        // Slide top view horizontally
        if (xPos/1000 - xOffset &gt; 250) {
            xOffset += ((xPos/1000 - xOffset) - 250) * 0.01;
        }
    }
    var _scale = 140000 / maxHeight;
    var mag = floor(log(maxHeight) / log(10));
    var w = 32 - 4 * mag;
    
    var scaleX = function(x) {
        return (xPos * (1 - _scale) + x * _scale) / 1000 - xOffset;
    };
    
    var scaleY = function(y) {
        return divY - 10 - (divY - 32) * y / maxHeight;
    };
    
    // Gradient background
    strokeWeight(1);
    var marsCol = color(204, 138, 116);
    var divY5 = divY - 5;
    var hfactor = maxHeight / 150000 / divY5;
    
    for (var y = 1; y &lt; divY5; y++) {
        stroke(lerpColor(marsCol, BLACK, pow(hfactor * y, 0.15)));
        line(0, divY - y, 400, divY - y);
    }
    
    // Draw ground
    noStroke();
    fill(133, 75, 57);
    drawGround(ground, 1200 / maxHeight);
    fill(97, 36, 16);
    drawGround(ground2, 800 / maxHeight);
    
    // Old positions
    fill(60, 200, 250, 80);
    for (var i=1; i&lt;oldPositions.length-1; i++) {
        var coord = oldPositions[i];
        if (coord[0] / 1000 &gt; 0) {
            ellipse(scaleX(coord[0]), scaleY(coord[1]), 3, 3);   
        }
    }
    
    // MSL positions
    var x = scaleX(position[0]);
    var y = scaleY(position[1]);
    
    stroke(255, 255, 255, 30);
    line(x + 10, y, 380, y);
    
    if (backshell) {
        drawBackshell(x, y, w);
    } else {
        var y2 = scaleY(backshellPos[1]);
        if (y2 &lt; divY) {
            var x2 = scaleX(backshellPos[0]);
            drawBackshell(x2, y2, w); 
        }
        
        if (skyCrane) {
            // Rover position
            var x2 = scaleX(roverPos[0]);
            var y2 = scaleY(roverPos[1]);

            // Wires
            stroke(255, 255, 255, 180);
            if (retrorockets !== 'flyaway') {
                line(x2 - w/4, y, x2 - w/4, y2 - 1);
                line(x2 + w/4, y, x2 + w/4, y2 - 1);   
            } else {
                var d = craneLength * _scale / 1000;
                var angle = atan2(y2 - y, x2 - x);
                var dx = d * cos(angle);
                var dy = d * sin(angle);
                line(x - w/4, y, x - w/4 + dx, y + dy);
                line(x + w/4, y, x + w/4 + dx, y + dy);
            }
            
            drawRover(x2, y2-2, w, mag);
        }

        strokeWeight(1);

        // Crane platform 
        stroke(100);
        fill(120);
        rect(x - w/2, y - w/4, w, w/2);
        fill(180);
        triangle(x - w/4, y-w/4+1, x - w/4, y+w/4-1, x - w*0.75, y+3);
        triangle(x + w/4, y-w/4+1, x + w/4, y+w/4-1, x + w*0.75, y+3);
        fill(200);
        stroke(40);
        ellipse(x, y, w/4, w/4);
    }
    
    // Altitude text
    var maxH = floor(maxHeight / pow(10, mag)) * pow(10, mag);
    if (maxHeight === 150000) {
        maxH = 150000;
    }

    x = 385;
    var y2 = scaleY(maxH);
    stroke(255);
    line(x, scaleY(0), x, y2);
    line(x-3, y, x, y);

    textFont(sansFont, 11);
    textAlign(RIGHT, BASELINE);
    fill(255);
    text("Altitude (m)", x - 2, 22);
    textFont(sansFont, 11);
    text("0", x - 4, divY - 4);
    textAlign(RIGHT, TOP);
    text(addComma(round(maxH)), x - 4, y2);
    textAlign(RIGHT, CENTER);
    
    if (position[1] &gt; 20) {
        text(addComma(round(position[1])), x - 4, y);   
    } else {
        text(""+round(position[1]*10)/10, x - 4, y);
    }
};

var drawEndScreen = function() {
    fill(255);
    textFont(impFont, 36);
    textAlign(CENTER, TOP);
    text(result, 200, divY + 10);
    
    textFont(sansFont, 14);
    textAlign(LEFT, TOP);
    var txt = "The Mars Science Laboratory ";
    switch (result) {
        case "Collision!":
            txt += " applied its retrorockets propelled itself into the backshell. It was destroyed on impact.";
            break;
        case "Crash!":
            txt += "hit the surface of Mars, travelling at ";
            txt += round(speed) + " m/s.";
            if (sliders[0].val &gt; 18) {
                txt += "\n\nTry a shallower angle of attack.";
            }
            break;
        case "Curiosity Overheated!":
            txt += "reached a temperature of "; 
            txt +=  writeDegrees(temperature) + " K and overheated.";
            txt += " It was " + round(position[1]) + " m above ";
            txt += "the surface of Mars, travelling at ";
            txt += round(speed) + " m/s.";
            txt += "\n\nTry jettisoning the heatshield later.";
            break;
        case "Insufficient fuel!":
            txt += "sky crane crashed into the rover, damaging it";
            txt += "\n\nYou need to slow down more before powered descent. Try a shallower angle of attack or open your parachute sooner.";
            break;
        case "Skimming away!":
            txt += "skimmed off the atmosphere and back into space.";
            txt += "\n\nTry a steeper angle of attack or executing ";
            txt += "SUFR at a slower speed.";
            break;
        case "Heavy landing!":
            txt += "was lowered from the skycrane travelling at ";
            txt += round(speed) + " m/s, ";
            if (!snatch) {
                txt += "without its wheels deployed, ";
            }
            txt += "and was damaged.";
            break;
        case "Dust damage!":
            txt += "was lowered from the skycrane, but damaged by";
            txt += " dust blown by the retrorockets";
            txt += "\nTry increasing the height at which the skycrane starts.";
            break;
    }

    if (result !== "Mission successful") {
        var tx = 25;
        fill(255);
        textAlign(LEFT, TOP);
        text(txt, tx, divY + 54, 400-tx*2, 400);
        //buttons[2].x = 240;
        //buttons[2].y = 353;
    } else {
        drawVectorMagnitudes();
        drawFuel();
        buttons[2].x = 130;
        buttons[2].y = 295;
    }
    buttons[0].showing = false;
    buttons[1].showing = false;
    buttons[2].showing = true;
    buttons[2].draw();
};

var draw = function() {
    background(0);

    if (divDY &gt; 0) {
        divDY--;
        divY++;
    }

    if (mode === 'choice') {
        drawParameterChoice();
    } else if (mode === 'running') {
        if (running) {
            time += dt;
            
            updateEvents();
            calculatePosition();
        }
        
        drawVectors();
        drawSideView();
        logEvents();
    } else {
        drawSideView();
        logEvents();
        drawEndScreen();
    }

    // Border
    noFill();
    stroke(0, 0, 0, 60);
    strokeWeight(6);
    rect(5, 5, 390, 390, 26);
    
    stroke(220, 220, 250);
    strokeWeight(20);
    rect(-5, -5, 410, 410, 40);
    
    stroke(120, 120, 150);
    strokeWeight(2);
    rect(5, 5, 390, 390, 26);
    
    /*
    strokeWeight(2);
    stroke(0, 0, 0, 60);
    arc(12, 12, 32, 32, -15, 105);
    noStroke();
    fill(220, 220, 250);
    ellipse(12, 12, 30, 30);
    strokeWeight(2);
    stroke(120, 120, 150);
    arc(12, 12, 30, 30, -20, 110);
    */
    
};

var mousePressed = function() {    
    for (var s in sliders) {
        sliders[s].selected();
    }
    
    for (var b in buttons) {
        buttons[b].click();
    }
};

var mouseReleased = function() {
    for (var s in sliders) {
        sliders[s].held = false;
    }
};

var mouseDragged = function() {
    for (var s in sliders) {
        sliders[s].drag();
    }
};

var keyPressed = function() {
    if (keyCode === 32) { running = !running; }
};</pre></div></div></div></div></div><div class="clearfix"><div class="perseus-renderer perseus-renderer-responsive"><div class="paragraph" data-perseus-paragraph-index="0"><h2>Research simulations</h2></div><div class="paragraph" data-perseus-paragraph-index="1"><div class="paragraph">Cosmologists are now using computational simulations to understand the history of the entire universe and predict its future, all the way from the Big Bang to its eventual end, billions of years from now. Those simulations can test out different theories to see which simulations create universes that are the most like our own. </div></div><div class="paragraph" data-perseus-paragraph-index="2"><div class="paragraph"><a class="_8gcxk83" href="http://www.tng-project.org/" rel="noopener noreferrer" tabindex="0" target="_blank">IllustrisTNG</a> is a research project that simulates galaxy formation by modeling factors like gravitational attraction, magnetic fields, the flow of gases, and the presence of dark matter.<span style="white-space: nowrap;"><span></span><span><span></span><span aria-describedby="katex-uid--1-described-by-id" aria-hidden="true" style="white-space: nowrap;"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mn>6</mn></msup></mrow><annotation encoding="application/x-tex">^6</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span><span id="katex-uid--1-described-by-id" style="border: 0px; clip: rect(0px, 0px, 0px, 0px); height: 1px; margin: -1px; overflow: hidden; padding: 0px; position: absolute; width: 1px;">start superscript, 6, end superscript</span></span><span></span></span></div></div><div class="paragraph" data-perseus-paragraph-index="3"><div class="paragraph">This video from IllustrisTNG simulates the formation of a galaxy very similar to our Milky Way galaxy:</div></div><div class="paragraph" data-perseus-paragraph-index="4"><div class="paragraph"><div class="perseus-widget-container widget-nohighlight widget-block"><div class="_xu2jcg"><div class="fixed-to-responsive" style="max-width: 1280px; max-height: 720px;"><div class="_s217esa">Khan Academy video wrapper</div><iframe allowfullscreen="" class="perseus-video-widget" height="720" sandbox="allow-same-origin allow-scripts" src="https://www.khanacademy.org/embed_video?slug=scientific-simulations-illustristng-single-galaxy-formation&amp;internal_video_only=1" width="1280"></iframe></div><div class="_44vsgjo"><span class="_f1191h">Scientific simulations: IllustrisTNG Single Galaxy Formation</span><div aria-hidden="true" class="_1opn8hgt"></div><a class="_1g8isxy8 visited-no-recolor" href="/transcript/xd63918660e2ca41b" rel="noopener noreferrer" tabindex="0" target="_blank">See video transcript</a></div></div></div></div></div><div class="paragraph" data-perseus-paragraph-index="5"><div class="paragraph">If a simulation can successfully output a galaxy that behaves like the Milky Way, then it may one day be able to predict the fate of our galaxy billions of years in the future. </div></div></div></div><div class="clearfix"><div class="perseus-renderer perseus-renderer-responsive"><div class="paragraph perseus-paragraph-centered" data-perseus-paragraph-index="0"><hr/></div><div class="paragraph" data-perseus-paragraph-index="1"><div class="paragraph">Do you have any questions about this topic? We'd love to answerjust ask in the questions area below! <div class="perseus-widget-container widget-nohighlight widget-inline"><div class="_167wsvl"><div class="_pupwzyp"><a aria-expanded="false" class="_13sgcdp7 _7n4oib" href="javascript:void(0)" role="button" tabindex="0">[Where is it?]</a></div></div></div></div></div></div></div></div>
</div>
</body>
</html>
